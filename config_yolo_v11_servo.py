#!/usr/bin/env python3
"""
YOLOv11 Arduino Firebase Bridge Configuration (Servo Edition)
‡πÑ‡∏ü‡∏•‡πå config ‡πÅ‡∏¢‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö YOLOv11 ‡∏û‡∏£‡πâ‡∏≠‡∏° Servo Control

Author: P2P Team
Version: 3.1 (Servo Edition)
"""

import os
import json
import serial.tools.list_ports
import cv2
import platform
from typing import Dict, List, Optional, Tuple

class YOLOv11ServoConfig:
    """‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö YOLOv11 Servo Detection"""
    
    # ========================================
    # Arduino & Servo Settings
    # ========================================
    ARDUINO_PORT = "COM5"  # ‡πÅ‡∏Å‡πâ‡∏ï‡∏≤‡∏°‡∏û‡∏≠‡∏£‡πå‡∏ï Arduino ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    ARDUINO_BAUD_RATE = 9600
    ARDUINO_TIMEOUT = 1
    SEND_DELAY = 1.0  # ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ Arduino (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
    
    # Servo Motor Settings
    SERVO_REST_POSITION = 90      # ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏û‡∏±‡∏Å (‡∏≠‡∏á‡∏®‡∏≤)
    SERVO_SWEEP_POSITION = 45     # ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏î‡∏Ç‡∏ß‡∏î (‡∏≠‡∏á‡∏®‡∏≤)
    SERVO_RETURN_POSITION = 135   # ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö (‡∏≠‡∏á‡∏®‡∏≤)
    SERVO_DELAY = 0.5            # ‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
    AUTO_SERVO_SWEEP = True       # ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏î‡∏Ç‡∏ß‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    SERVO_TEST_ANGLES = [0, 45, 90, 135, 180]  # ‡∏°‡∏∏‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
    
    # ========================================
    # YOLOv11 Settings
    # ========================================
    MODEL_PATH = "best.pt"        # path ‡πÑ‡∏õ‡∏¢‡∏±‡∏á YOLOv11 model
    TARGET_CLASS_ID = 0           # ID ‡∏Ç‡∏≠‡∏á plastic bottle ‡πÉ‡∏ô dataset
    CONF_THRESHOLD = 0.80         # Confidence ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥
    IOU_THRESHOLD = 0.45          # IoU threshold ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö NMS
    MAX_DETECTIONS = 300          # ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
    
    # ========================================
    # Camera Settings
    # ========================================
    CAM_ID = 1                    # Camera ID (0, 1, 2...)
    IMG_SIZE = 640                # ‡∏Ç‡∏ô‡∏≤‡∏î‡∏†‡∏≤‡∏û‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö inference
    FPS_TARGET = 30               # FPS ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
    DEVICE = "cpu"                # "cpu" ‡∏´‡∏£‡∏∑‡∏≠ "cuda" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö GPU
    
    # Camera Resolution
    CAM_WIDTH = 1280
    CAM_HEIGHT = 720
    
    # ========================================
    # Firebase Settings
    # ========================================
    FIREBASE_URL = "https://takultoujink-default-rtdb.asia-southeast1.firebasedatabase.app"
    USER_ID = "yolo_v11_servo_user"
    FIREBASE_TIMEOUT = 10         # Timeout ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Firebase requests
    
    # Firebase Paths
    BOTTLE_DATA_PATH = "bottle_servo_data"
    SERVO_DATA_PATH = "servo_data"
    SYSTEM_STATUS_PATH = "system_status"
    
    # ========================================
    # Performance Settings
    # ========================================
    DETECTION_COOLDOWN = 2.0      # ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏Ç‡∏ß‡∏î (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
    POINTS_PER_BOTTLE = 10        # ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≠‡∏Ç‡∏ß‡∏î
    MAX_BOTTLE_COUNT = 9999       # ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏ß‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
    
    # Threading Settings
    USE_THREADING = True          # ‡πÉ‡∏ä‡πâ threading ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Firebase
    THREAD_TIMEOUT = 5.0          # Timeout ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö threads
    
    # ========================================
    # Display Settings
    # ========================================
    WINDOW_NAME = "YOLOv11 P2P Detection with Servo Control (ESC to quit)"
    WINDOW_WIDTH = 1280
    WINDOW_HEIGHT = 720
    
    # Colors (BGR format)
    COLOR_GREEN = (0, 255, 0)
    COLOR_RED = (0, 0, 255)
    COLOR_BLUE = (255, 0, 0)
    COLOR_YELLOW = (0, 255, 255)
    COLOR_WHITE = (255, 255, 255)
    COLOR_BLACK = (0, 0, 0)
    
    # Font Settings
    FONT = cv2.FONT_HERSHEY_SIMPLEX
    FONT_SCALE = 0.45
    FONT_THICKNESS = 1
    
    # ========================================
    # Logging Settings
    # ========================================
    LOG_LEVEL = "INFO"            # DEBUG, INFO, WARNING, ERROR
    LOG_TO_FILE = True            # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå
    LOG_FILE = "yolo_v11_servo.log"
    MAX_LOG_SIZE = 10 * 1024 * 1024  # 10MB
    
    # ========================================
    # Advanced Settings
    # ========================================
    ENABLE_GPU = True             # ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏ä‡πâ GPU ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    ENABLE_HALF_PRECISION = False # ‡πÉ‡∏ä‡πâ FP16 (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ GPU)
    ENABLE_TensorRT = False       # ‡πÉ‡∏ä‡πâ TensorRT optimization
    
    # Error Handling
    MAX_RETRIES = 3               # ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
    RETRY_DELAY = 1.0             # ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
    
    # System Monitoring
    MONITOR_SYSTEM = True         # ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° CPU, Memory usage
    MONITOR_INTERVAL = 30.0       # ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
    
    @classmethod
    def auto_detect_camera(cls) -> int:
        """‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤ Camera ID ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ"""
        print("üîç Auto-detecting camera...")
        
        for cam_id in range(5):  # ‡∏ó‡∏î‡∏™‡∏≠‡∏ö camera 0-4
            try:
                cap = cv2.VideoCapture(cam_id)
                if cap.isOpened():
                    ret, frame = cap.read()
                    if ret and frame is not None:
                        print(f"‚úÖ Camera found at ID: {cam_id}")
                        cap.release()
                        return cam_id
                cap.release()
            except Exception as e:
                continue
        
        print("‚ùå No camera detected, using default ID: 0")
        return 0
    
    @classmethod
    def auto_detect_arduino_port(cls) -> str:
        """‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤ Arduino port ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥"""
        print("üîç Auto-detecting Arduino port...")
        
        ports = serial.tools.list_ports.comports()
        arduino_ports = []
        
        for port in ports:
            # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Arduino ‡∏ï‡∏≤‡∏° description
            if any(keyword in port.description.lower() for keyword in 
                   ['arduino', 'ch340', 'cp210', 'ftdi', 'usb serial']):
                arduino_ports.append(port.device)
                print(f"‚úÖ Potential Arduino port: {port.device} - {port.description}")
        
        if arduino_ports:
            return arduino_ports[0]  # ‡πÉ‡∏ä‡πâ‡∏û‡∏≠‡∏£‡πå‡∏ï‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠
        
        # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏ä‡πâ default ‡∏ï‡∏≤‡∏° OS
        if platform.system() == "Windows":
            default_port = "COM5"
        else:
            default_port = "/dev/ttyUSB0"
        
        print(f"‚ùå No Arduino detected, using default: {default_port}")
        return default_port
    
    @classmethod
    def detect_gpu_support(cls) -> str:
        """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPU"""
        try:
            import torch
            if torch.cuda.is_available():
                gpu_name = torch.cuda.get_device_name(0)
                print(f"‚úÖ CUDA GPU detected: {gpu_name}")
                return "cuda"
        except ImportError:
            pass
        
        print("üíª Using CPU for inference")
        return "cpu"
    
    @classmethod
    def create_optimized_config(cls) -> 'YOLOv11ServoConfig':
        """‡∏™‡∏£‡πâ‡∏≤‡∏á config ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö"""
        config = cls()
        
        # Auto-detect settings
        config.CAM_ID = cls.auto_detect_camera()
        config.ARDUINO_PORT = cls.auto_detect_arduino_port()
        config.DEVICE = cls.detect_gpu_support()
        
        # Optimize based on device
        if config.DEVICE == "cuda":
            config.IMG_SIZE = 640
            config.FPS_TARGET = 30
            config.ENABLE_HALF_PRECISION = True
        else:
            config.IMG_SIZE = 416  # ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö CPU
            config.FPS_TARGET = 15
            config.ENABLE_HALF_PRECISION = False
        
        return config
    
    def get_servo_preset_positions(self) -> Dict[str, int]:
        """‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Servo ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ"""
        return {
            "rest": self.SERVO_REST_POSITION,
            "sweep": self.SERVO_SWEEP_POSITION,
            "return": self.SERVO_RETURN_POSITION,
            "left_max": 0,
            "left_mid": 45,
            "center": 90,
            "right_mid": 135,
            "right_max": 180
        }
    
    def get_keyboard_controls(self) -> Dict[str, str]:
        """‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î"""
        return {
            "ESC": "Quit system",
            "r": "Reset counter and servo",
            "s": "Show system status",
            "t": "Test servo motor",
            "w": "Manual bottle sweep",
            "h": "Move servo to rest position",
            "1-9": "Move servo to preset positions (0¬∞-160¬∞)",
            "q": "Quick servo test",
            "p": "Toggle auto-sweep mode",
            "c": "Calibrate servo",
            "d": "Debug mode toggle"
        }
    
    def validate_config(self) -> List[str]:
        """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á config"""
        errors = []
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Model file
        if not os.path.exists(self.MODEL_PATH):
            errors.append(f"Model file not found: {self.MODEL_PATH}")
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Servo angles
        if not 0 <= self.SERVO_REST_POSITION <= 180:
            errors.append(f"Invalid servo rest position: {self.SERVO_REST_POSITION}")
        
        if not 0 <= self.SERVO_SWEEP_POSITION <= 180:
            errors.append(f"Invalid servo sweep position: {self.SERVO_SWEEP_POSITION}")
        
        if not 0 <= self.SERVO_RETURN_POSITION <= 180:
            errors.append(f"Invalid servo return position: {self.SERVO_RETURN_POSITION}")
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Confidence threshold
        if not 0.0 <= self.CONF_THRESHOLD <= 1.0:
            errors.append(f"Invalid confidence threshold: {self.CONF_THRESHOLD}")
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase URL
        if not self.FIREBASE_URL.startswith("https://"):
            errors.append(f"Invalid Firebase URL: {self.FIREBASE_URL}")
        
        return errors
    
    def save_to_file(self, filename: str = "config_local.json") -> bool:
        """‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å config ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå"""
        try:
            config_dict = {
                "arduino_port": self.ARDUINO_PORT,
                "model_path": self.MODEL_PATH,
                "target_class_id": self.TARGET_CLASS_ID,
                "conf_threshold": self.CONF_THRESHOLD,
                "cam_id": self.CAM_ID,
                "device": self.DEVICE,
                "firebase_url": self.FIREBASE_URL,
                "user_id": self.USER_ID,
                "servo_rest_position": self.SERVO_REST_POSITION,
                "servo_sweep_position": self.SERVO_SWEEP_POSITION,
                "servo_return_position": self.SERVO_RETURN_POSITION,
                "auto_servo_sweep": self.AUTO_SERVO_SWEEP,
                "servo_delay": self.SERVO_DELAY
            }
            
            with open(filename, 'w', encoding='utf-8') as f:
                json.dump(config_dict, f, indent=2, ensure_ascii=False)
            
            print(f"‚úÖ Config saved to: {filename}")
            return True
            
        except Exception as e:
            print(f"‚ùå Failed to save config: {e}")
            return False
    
    def print_config_summary(self):
        """‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ config"""
        print("\n" + "="*80)
        print("üìã YOLOv11 SERVO SYSTEM CONFIGURATION")
        print("="*80)
        print(f"ü§ñ Model: {self.MODEL_PATH}")
        print(f"üéØ Target Class: {self.TARGET_CLASS_ID}")
        print(f"üìä Confidence: {self.CONF_THRESHOLD}")
        print(f"üìπ Camera: {self.CAM_ID}")
        print(f"üíª Device: {self.DEVICE}")
        print(f"üîå Arduino: {self.ARDUINO_PORT}")
        print(f"üîß Servo Rest: {self.SERVO_REST_POSITION}¬∞")
        print(f"üßπ Servo Sweep: {self.SERVO_SWEEP_POSITION}¬∞")
        print(f"‚Ü©Ô∏è  Servo Return: {self.SERVO_RETURN_POSITION}¬∞")
        print(f"üîÑ Auto Sweep: {'Enabled' if self.AUTO_SERVO_SWEEP else 'Disabled'}")
        print(f"üî• Firebase: {self.FIREBASE_URL.split('.')[0]}...")
        print(f"üë§ User ID: {self.USER_ID}")
        print("="*80 + "\n")

def load_local_config(filename: str = "config_local.json") -> Optional[YOLOv11ServoConfig]:
    """‡πÇ‡∏´‡∏•‡∏î config ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå local"""
    if not os.path.exists(filename):
        print(f"üìÑ Local config not found: {filename}")
        return None
    
    try:
        with open(filename, 'r', encoding='utf-8') as f:
            config_dict = json.load(f)
        
        config = YOLOv11ServoConfig()
        
        # ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï config ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå
        for key, value in config_dict.items():
            if hasattr(config, key.upper()):
                setattr(config, key.upper(), value)
        
        print(f"‚úÖ Local config loaded: {filename}")
        return config
        
    except Exception as e:
        print(f"‚ùå Failed to load local config: {e}")
        return None

def validate_config(config: YOLOv11ServoConfig) -> bool:
    """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á config"""
    errors = config.validate_config()
    
    if errors:
        print("‚ùå Configuration errors found:")
        for error in errors:
            print(f"   - {error}")
        return False
    
    print("‚úÖ Configuration validation passed")
    return True

def create_default_config() -> YOLOv11ServoConfig:
    """‡∏™‡∏£‡πâ‡∏≤‡∏á config ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô"""
    print("üîß Creating default configuration...")
    return YOLOv11ServoConfig.create_optimized_config()

if __name__ == "__main__":
    # ‡∏ó‡∏î‡∏™‡∏≠‡∏ö config
    print("üß™ Testing YOLOv11 Servo Configuration...")
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á config ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    config = create_default_config()
    
    # ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ
    config.print_config_summary()
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    if validate_config(config):
        print("‚úÖ Configuration test passed!")
        
        # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå
        config.save_to_file("config_test.json")
    else:
        print("‚ùå Configuration test failed!")
    
    # ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°
    print("\nüéÆ Keyboard Controls:")
    controls = config.get_keyboard_controls()
    for key, description in controls.items():
        print(f"   {key:8} - {description}")
    
    # ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Servo
    print("\nüîß Servo Preset Positions:")
    positions = config.get_servo_preset_positions()
    for name, angle in positions.items():
        print(f"   {name:12} - {angle:3}¬∞")