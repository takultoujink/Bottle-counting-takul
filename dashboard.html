<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>P2P</title>
  <meta name="description" content="Dashboard สำหรับติดตามจำนวนขวดแบบ Real-time" />
  
  <!-- AOS Animation Library -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" />
  <style>
    :root{
      --bg: #0b1020;          /* พื้นหลังเข้ม */
      --card: #121833;        /* การ์ดเข้ม */
      --text: #e7eaf6;        /* ข้อความหลัก */
      --muted: #aab1d6;       /* ข้อความรอง */
      --brand: #7c5cff;       /* สีหลัก */
      --brand-2: #22d3ee;     /* สีรอง */
      --ok: #34d399;          /* สำเร็จ */
      --warn: #fbbf24;        /* เตือน */
      --error: #ef4444;       /* ผิดพลาด */
      --radius-xl: 20px;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --shadow-soft: 0 6px 18px rgba(0,0,0,.22);
    }

    /* รีเซ็ตเล็กน้อย */
    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans Thai", "Noto Sans", "Liberation Sans", sans-serif;
      color:var(--text); 
      background: 
        radial-gradient(1200px 600px at 10% -10%, rgba(124,92,255,.35), transparent 55%), 
        radial-gradient(1200px 800px at 110% 0%, rgba(34,211,238,.25), transparent 55%), 
        var(--bg);
      line-height:1.6; letter-spacing:.2px;
    }
    
    /* Dashboard Watermark overlay */
    body::before {
      content: '';
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 350px;
      height: 350px;
      background: url('ขวดโรงเรียน.jpg') no-repeat center center;
      background-size: contain;
      opacity: 0.02;
      z-index: 0;
      pointer-events: none;
    }

    .container{ width:min(1200px, 95%); margin-inline:auto; }

    /* Navbar */
    .nav{ position:sticky; top:0; z-index:50; backdrop-filter:saturate(140%) blur(8px); background:rgba(11,16,32,.8); border-bottom:1px solid rgba(255,255,255,.05); }
    .nav-inner{ display:flex; align-items:center; justify-content:space-between; padding:14px 0; }
    .brand{ display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text); font-weight:700; }
    .logo{ width:36px; height:36px; border-radius:10px; background: conic-gradient(from 210deg at 50% 50%, var(--brand), var(--brand-2), var(--brand)); box-shadow: var(--shadow-soft); }
    .logo-img{ width:40px; height:40px; border-radius:10px; object-fit:cover; box-shadow: var(--shadow-soft); }
    .nav-actions{ display:flex; align-items:center; gap:12px; }
    .user-info{ display:flex; align-items:center; gap:8px; color:var(--muted); }
    .avatar{ width:32px; height:32px; border-radius:50%; background:linear-gradient(135deg, var(--brand), var(--brand-2)); }
    .btn-logout{ appearance:none; border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.05); color:var(--text); padding:8px 12px; border-radius:8px; cursor:pointer; font-size:14px; transition:.2s ease; }
    .btn-logout:hover{ background:var(--error); border-color:var(--error); }

    /* Header */
    .header{ padding:32px 0 24px; }
    .header h1{ margin:0; font-size: clamp(28px, 4vw, 36px); }
    .header p{ color:var(--muted); margin:8px 0 0; }

    /* Status indicator */
    .status{ display:inline-flex; align-items:center; gap:8px; padding:6px 12px; border-radius:999px; font-size:14px; margin-top:12px; }
    .status.online{ background:rgba(52,211,153,.1); border:1px solid rgba(52,211,153,.3); color:var(--ok); }
    .status.offline{ background:rgba(239,68,68,.1); border:1px solid rgba(239,68,68,.3); color:var(--error); }
    .pulse-dot{ width:8px; height:8px; border-radius:50%; }
    .pulse-dot.online{ background:var(--ok); animation: pulse 2s infinite; }
    .pulse-dot.offline{ background:var(--error); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Main grid */
    .dashboard-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:24px; margin-bottom:32px; }
    
    /* Cards */
    .card{ background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); border:1px solid rgba(255,255,255,.12); border-radius: var(--radius-xl); padding:24px; box-shadow: var(--shadow-soft); }
    .card h3{ margin:0 0 16px; font-size:18px; color:var(--muted); display:flex; align-items:center; gap:8px; }

    /* Counter card */
    .counter-main{ text-align:center; }
    .bottle-count{ font-size: clamp(48px, 8vw, 72px); font-weight:800; margin:16px 0; background: linear-gradient(135deg, var(--brand), var(--brand-2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .bottle-icon{ font-size:48px; margin-bottom:12px; }
    .last-updated{ color:var(--muted); font-size:14px; margin-top:8px; }

    /* Stats grid */
    .stats-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .stat-item{ background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:16px; text-align:center; }
    .stat-number{ font-size:24px; font-weight:700; margin-bottom:4px; }
    .stat-label{ font-size:12px; color:var(--muted); }

    /* History table */
    .history-table{ width:100%; border-collapse:collapse; }
    .history-table th{ text-align:left; padding:12px 8px; border-bottom:1px solid rgba(255,255,255,.1); color:var(--muted); font-size:14px; }
    .history-table td{ padding:12px 8px; border-bottom:1px solid rgba(255,255,255,.05); }
    .time-badge{ background:rgba(255,255,255,.06); padding:4px 8px; border-radius:6px; font-size:12px; }

    /* Progress bar */
    .progress-container{ margin:16px 0; }
    .progress-label{ display:flex; justify-content:space-between; margin-bottom:8px; font-size:14px; }
    .progress-bar{ height:8px; background:rgba(255,255,255,.1); border-radius:4px; overflow:hidden; }
    .progress-fill{ height:100%; background:linear-gradient(90deg, var(--brand), var(--brand-2)); transition: width 0.3s ease; border-radius:4px; }

    /* Alert */
    .alert{ padding:16px; border-radius:12px; margin-bottom:24px; display:flex; align-items:center; gap:12px; }
    .alert.success{ background:rgba(52,211,153,.1); border:1px solid rgba(52,211,153,.3); color:var(--ok); }
    .alert.warning{ background:rgba(251,191,36,.1); border:1px solid rgba(251,191,36,.3); color:var(--warn); }

    /* Responsive */
    @media (max-width: 800px){
      .dashboard-grid{ grid-template-columns: 1fr; }
      .stats-grid{ grid-template-columns: 1fr; }
    }

    /* Loading animation */
    .loading{ display:inline-block; width:20px; height:20px; border:2px solid rgba(255,255,255,.1); border-radius:50%; border-top-color:var(--brand); animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Enhanced bottle image */
    .bottle-img {
      max-width: 180px;
      margin-bottom: 15px;
      transition: transform 0.5s ease;
    }
    .bottle-img:hover {
      transform: scale(1.05) rotate(3deg);
    }
    
    /* Enhanced card styles */
    .card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: 1px solid rgba(255,255,255,0.05);
      overflow: hidden;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.4);
    }
    
    /* Enhanced stat items */
    .stat-item {
      position: relative;
      overflow: hidden;
      transition: transform 0.3s ease;
      cursor: pointer;
    }
    .stat-item:hover {
      transform: translateY(-3px);
    }
    .stat-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, rgba(124,92,255,0.2), transparent 70%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .stat-item:hover::before {
      opacity: 1;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.08));
      border: 1px solid rgba(255,255,255,.2);
      border-radius: var(--radius-xl);
      padding: 40px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      transform: scale(0.7) translateY(50px);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      position: relative;
    }

    .modal-overlay.active .modal-content {
      transform: scale(1) translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,.1);
    }

    .modal-title {
      font-size: 28px;
      font-weight: 700;
      margin: 0;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .modal-close {
      background: rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.2);
      color: var(--text);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: var(--error);
      border-color: var(--error);
      transform: rotate(90deg);
    }

    .modal-stat-display {
      text-align: center;
      margin: 30px 0;
    }

    .modal-stat-number {
      font-size: 72px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
      animation: pulse-glow 2s infinite;
    }

    .modal-stat-label {
      font-size: 24px;
      color: var(--muted);
      margin-bottom: 20px;
    }

    .modal-stat-description {
      font-size: 16px;
      color: var(--text);
      line-height: 1.6;
      background: rgba(255,255,255,.05);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.1);
    }

    @keyframes pulse-glow {
      0%, 100% {
        filter: drop-shadow(0 0 10px rgba(124,92,255,0.3));
      }
      50% {
        filter: drop-shadow(0 0 20px rgba(124,92,255,0.6));
      }
    }

    .modal-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .modal-mini-stat {
      background: rgba(255,255,255,.05);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid rgba(255,255,255,.1);
    }

    .modal-mini-stat-number {
      font-size: 24px;
      font-weight: 700;
      color: var(--brand);
      margin-bottom: 5px;
    }

    .modal-mini-stat-label {
      font-size: 12px;
      color: var(--muted);
    }

    /* Modal Animation */
    .modal-overlay {
      opacity: 0;
      transform: scale(0.9);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .modal-overlay.active {
      opacity: 1;
      transform: scale(1);
    }

    .modal-content {
      transform: translateY(20px);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }

    /* Pulse animation for main stat number */
    .modal-stat-number {
      animation: pulse-glow 2s ease-in-out infinite;
    }

    @keyframes pulse-glow {
      0%, 100% {
        transform: scale(1);
        text-shadow: 0 0 20px rgba(74, 144, 226, 0.3);
      }
      50% {
        transform: scale(1.05);
        text-shadow: 0 0 30px rgba(74, 144, 226, 0.6);
      }
    }

    /* Calendar Styles */
    .calendar-container {
      margin-top: 12px;
    }
    
    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      padding: 0 6px;
    }
    
    .calendar-nav {
      background: rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.2);
      color: var(--text);
      width: 28px;
      height: 28px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .calendar-nav:hover {
      background: var(--brand);
      border-color: var(--brand);
      transform: scale(1.05);
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 3px;
      margin-bottom: 12px;
    }
    
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      min-height: 35px;
      font-size: 12px;
    }
    
    .calendar-day:hover {
      background: rgba(255,255,255,.1);
      transform: translateY(-2px);
    }
    
    .calendar-day.today {
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      color: white;
      font-weight: bold;
    }
    
    .calendar-day.has-data {
      background: rgba(52,211,153,.2);
      border-color: var(--ok);
    }
    
    .calendar-day.selected {
      background: var(--brand);
      color: white;
      transform: scale(1.05);
    }
    
    .calendar-day.other-month {
      opacity: 0.3;
      pointer-events: none;
    }
    
    .calendar-day-number {
      font-weight: 600;
      font-size: 11px;
    }
    
    .calendar-day-bottles {
      font-size: 8px;
      color: var(--ok);
      margin-top: 1px;
    }
    
    .calendar-weekday {
      text-align: center;
      padding: 6px 3px;
      font-size: 10px;
      color: var(--muted);
      font-weight: 600;
    }
    
    .selected-date-info {
      margin-top: 15px;
      padding: 12px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 10px;
    }
    
    .date-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin: 12px 0;
    }
    
    .date-stat {
      text-align: center;
      padding: 8px;
      background: rgba(255,255,255,.06);
      border-radius: 6px;
    }
    
    .date-stat .stat-number {
      display: block;
      font-size: 16px;
      font-weight: bold;
      color: var(--brand);
    }
    
    .date-stat .stat-label {
      font-size: 10px;
      color: var(--muted);
      margin-top: 3px;
    }
    
    .date-activities {
      margin-top: 12px;
    }
    
    .activity-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px;
      background: rgba(255,255,255,.04);
      border-radius: 5px;
      margin-bottom: 6px;
      font-size: 12px;
    }
    
    .activity-time {
      color: var(--muted);
      font-size: 10px;
    }
    
    .activity-bottles {
      color: var(--ok);
      font-weight: 600;
      font-size: 11px;
    }

    /* Team Selection Modal Styles */
    .team-selection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .team-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      background: rgba(255,255,255,.05);
      border: 2px solid rgba(255,255,255,.1);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .team-option:hover {
      background: rgba(255,255,255,.1);
      border-color: rgba(255,255,255,.3);
      transform: translateY(-5px);
    }

    .team-option.selected {
      background: rgba(124,92,255,.2);
      border-color: var(--brand);
      transform: translateY(-5px) scale(1.05);
    }

    .team-color-circle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin-bottom: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,.3);
      transition: all 0.3s ease;
    }

    .team-option:hover .team-color-circle {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0,0,0,.4);
    }

    .team-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
    }

    .team-option.selected .team-name {
      color: var(--brand);
    }

    #confirmTeamBtn:hover {
      background: var(--brand-2);
      transform: translateY(-2px);
    }

  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="nav" data-aos="fade-down" data-aos-duration="800">
    <div class="container nav-inner">
      <a class="brand" href="index.html">
        <img src="logo web ขวด.jpg" alt="P2P Logo" class="logo-img" style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: transform 0.3s ease;" href="index.html">
        <span>P2P</span>
      </a>
      <div class="nav-actions">
        <div class="user-info">
          <div class="avatar" aria-hidden="true"></div>
          <div style="display: flex; flex-direction: column; align-items: flex-start;">
            <span id="userName">Loading...</span>
            <div id="userTeam" style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--muted); margin-top: 2px;">
              <div id="teamColorIndicator" style="width: 12px; height: 12px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3);"></div>
              <span id="teamColorName">กำลังโหลด...</span>
              <button id="selectTeamBtn" style="display: none; background: var(--brand); color: white; border: none; padding: 2px 6px; border-radius: 4px; font-size: 10px; cursor: pointer; margin-left: 4px;" onclick="openTeamSelectionModal()">เลือกทีม</button>
            </div>
          </div>
          <button class="btn-logout" style="background:var(--brand-2); color:#222; border:none;" onclick="toggleTheme()">Bright</button>
        </div>
        
        <button class="btn-logout" onclick="logout()">ออกจากระบบ</button>
      </div>
    </div>
  </nav>

  <!-- HEADER -->
  <header class="header">
    <div class="container" data-aos="fade-up" data-aos-duration="1000" data-aos-delay="200">
      <h1>P2P (Plastic to Point) - ระบบนับขวด</h1>
      <p>ติดตามจำนวนขวดที่นับได้แบบ Real-time และคำนวณชั่วโมงจิตอาสา</p>
      <div class="status" id="connectionStatus">
        <div class="pulse-dot offline"></div>
        <span>กำลังเชื่อมต่อ...</span>
      </div>
    </div>
  </header>

  <!-- MAIN DASHBOARD -->
  <main class="container">
    
    <!-- Alert for first time users -->
    <div class="alert success" id="welcomeAlert" style="display:none;">
      <span>🎉</span>
      <div>
        <strong>ยินดีต้อนรับ!</strong>
        <div>ระบบพร้อมทำงาน เครื่องนับขวดจะอัพเดทข้อมูลแบบ Real-time</div>
        <div style="margin-top:8px; font-size:13px; color:var(--muted);">
          💡 <strong>วิธีคำนวณจิตอาสา:</strong> ทุก 30 ขวด = 1 ชั่วโมงจิตอาสา
        </div>
        <button class="btn-logout" style="background:var(--brand-2); color:#222; border:none; margin-top:10px;" onclick="toggleTheme()">เปลี่ยนธีม Bright</button>
        <script>
            // Improved Bright/Dark Theme Toggle with Animation & More Colors
            function toggleTheme() {
            const root = document.documentElement;
            const isDark = root.style.getPropertyValue('--bg') === '#0b1020' || !root.style.getPropertyValue('--bg');
            if (isDark) {
              // Bright mode: more playful gradients, soft shadows, animated transition
              root.style.setProperty('--bg', '#f8fafc');
              root.style.setProperty('--card', '#fff');
              root.style.setProperty('--text', '#232946');
              root.style.setProperty('--muted', '#6b7280');
              root.style.setProperty('--brand', '#7c5cff');
              root.style.setProperty('--brand-2', '#22d3ee');
              root.style.setProperty('--ok', '#10b981');
              root.style.setProperty('--warn', '#f59e42');
              root.style.setProperty('--error', '#ef4444');
              root.style.setProperty('--shadow', '0 8px 32px rgba(124,92,255,.10)');
              root.style.setProperty('--shadow-soft', '0 4px 16px rgba(34,211,238,.10)');
              root.style.setProperty('--radius-xl', '24px');
              root.style.setProperty('--radius', '16px');
              document.body.style.transition = "background 0.7s cubic-bezier(.4,2,.6,1)";
              document.body.style.background = 
              "radial-gradient(1200px 600px at 10% -10%, rgba(124,92,255,.12), transparent 55%)," +
              "radial-gradient(1200px 800px at 110% 0%, rgba(34,211,238,.10), transparent 55%)," +
              "linear-gradient(120deg, #f8fafc 60%, #e0e7ff 100%)";
              // Add a subtle confetti animation for fun
              if (!document.getElementById('confetti-canvas')) {
              const canvas = document.createElement('canvas');
              canvas.id = 'confetti-canvas';
              canvas.style.position = 'fixed';
              canvas.style.top = 0;
              canvas.style.left = 0;
              canvas.style.width = '100vw';
              canvas.style.height = '100vh';
              canvas.style.pointerEvents = 'none';
              canvas.style.zIndex = 9999;
              document.body.appendChild(canvas);
              launchConfetti(canvas);
              setTimeout(() => {
                if (canvas.parentNode) canvas.parentNode.removeChild(canvas);
              }, 1200);
              }
            } else {
              // Back to dark mode
              root.style.setProperty('--bg', '#0b1020');
              root.style.setProperty('--card', '#121833');
              root.style.setProperty('--text', '#e7eaf6');
              root.style.setProperty('--muted', '#aab1d6');
              root.style.setProperty('--brand', '#7c5cff');
              root.style.setProperty('--brand-2', '#22d3ee');
              root.style.setProperty('--ok', '#34d399');
              root.style.setProperty('--warn', '#fbbf24');
              root.style.setProperty('--error', '#ef4444');
              root.style.setProperty('--shadow', '0 10px 30px rgba(0,0,0,.35)');
              root.style.setProperty('--shadow-soft', '0 6px 18px rgba(0,0,0,.22)');
              root.style.setProperty('--radius-xl', '20px');
              root.style.setProperty('--radius', '14px');
              document.body.style.transition = "background 0.7s cubic-bezier(.4,2,.6,1)";
              document.body.style.background = "";
            }
            }

            // Simple confetti animation for bright mode
            function launchConfetti(canvas) {
            const ctx = canvas.getContext('2d');
            const W = window.innerWidth, H = window.innerHeight;
            canvas.width = W;
            canvas.height = H;
            const colors = ['#7c5cff', '#22d3ee', '#f59e42', '#10b981', '#ef4444', '#fff'];
            const confetti = Array.from({length: 32}, () => ({
              x: Math.random() * W,
              y: Math.random() * -H,
              r: 6 + Math.random() * 8,
              d: 8 + Math.random() * 12,
              color: colors[Math.floor(Math.random() * colors.length)],
              tilt: Math.random() * 10 - 5,
              tiltAngle: 0,
              tiltAngleIncremental: (Math.random() * 0.07) + 0.05
            }));
            let frame = 0;
            function draw() {
              ctx.clearRect(0, 0, W, H);
              confetti.forEach(c => {
              ctx.beginPath();
              ctx.ellipse(c.x, c.y, c.r, c.r/2, c.tilt, 0, 2 * Math.PI);
              ctx.fillStyle = c.color;
              ctx.globalAlpha = 0.85;
              ctx.fill();
              });
            }
            function update() {
              confetti.forEach(c => {
              c.y += Math.cos(frame/10 + c.d) + 2 + c.r/6;
              c.x += Math.sin(frame/15) * 2;
              c.tiltAngle += c.tiltAngleIncremental;
              c.tilt = Math.sin(c.tiltAngle) * 8;
              if (c.y > H + 20) {
                c.y = -10;
                c.x = Math.random() * W;
              }
              });
            }
            function animate() {
              frame++;
              update();
              draw();
              if (frame < 60) requestAnimationFrame(animate);
            }
            animate();
            }
        </script>
      </div>
    </div>

    <div class="dashboard-grid">
      
      <!-- MAIN COUNTER -->
      <div class="card counter-main" data-aos="zoom-in" data-aos-duration="1200" data-aos-delay="400">
        <img src="อิ่มถ่าย.jpg" alt="ขวดโรงเรียน" class="bottle-img" style="border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.15); transition: transform 0.3s ease;">
        <h3>จำนวนขวดทั้งหมด</h3>
        <div class="bottle-count" id="totalBottles">
          <span class="loading"></span>
        </div>
        <div class="last-updated" id="lastUpdated">กำลังโหลด...</div>
        
        <div class="progress-container">
          <div class="progress-label">
            <span>เป้าหมายวันนี้</span>
            <span id="progressPercent">0%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <!-- STATISTICS -->
      <div class="card" data-aos="fade-left" data-aos-duration="1000" data-aos-delay="600">
        <h3>📊 สถิติและจิตอาสา</h3>
        <div class="stats-grid">
          <div class="stat-item" data-aos="fade-up" data-aos-duration="800" data-aos-delay="800" onclick="openStatModal('today')">
            <div class="stat-number" id="todayCount">0</div>
            <div class="stat-label">ขวดวันนี้</div>
          </div>
          <div class="stat-item" data-aos="fade-up" data-aos-duration="800" data-aos-delay="900" onclick="openStatModal('volunteer')">
            <div class="stat-number" id="volunteerHours">0</div>
            <div class="stat-label">ชม.จิตอาสา</div>
          </div>
          <div class="stat-item" data-aos="fade-up" data-aos-duration="800" data-aos-delay="1000" onclick="openStatModal('total')">
            <div class="stat-number" id="totalBottlesAll">0</div>
            <div class="stat-label">ขวดรวมทั้งหมด</div>
          </div>
          <div class="stat-item" data-aos="fade-up" data-aos-duration="800" data-aos-delay="1100" onclick="openStatModal('weekly')">
            <div class="stat-number" id="weeklyCount">0</div>
            <div class="stat-label">ขวดสัปดาห์นี้</div>
          </div>
        </div>
        
        <!-- Volunteer Hours Info -->
        <div style="margin-top:16px; padding:12px; background:rgba(124,92,255,.1); border:1px solid rgba(124,92,255,.3); border-radius:8px; font-size:13px; text-align:center;">
          <strong>💡 วิธีการคำนวณ:</strong> ทุก 30 ขวด = 1 ชั่วโมงจิตอาสา
        </div>
      </div>
    </div>

    <!-- BOTTLE COLLECTION CALENDAR -->
    <div class="card" data-aos="fade-up" data-aos-duration="1200" data-aos-delay="1000">
      <h3>📅 ปฏิทินการเก็บขวด</h3>
      <div class="calendar-container">
        <div class="calendar-header">
          <button class="calendar-nav" id="prevMonth">‹</button>
          <h4 id="currentMonth">กำลังโหลด...</h4>
          <button class="calendar-nav" id="nextMonth">›</button>
        </div>
        <div class="calendar-grid" id="calendarGrid">
          <!-- Calendar will be generated here -->
        </div>
      </div>
      
      <!-- Selected Date Info -->
      <div class="selected-date-info" id="selectedDateInfo" style="display:none;">
        <h4 id="selectedDate">วันที่เลือก</h4>
        <div class="date-stats">
          <div class="date-stat">
            <span class="stat-number" id="selectedDateBottles">0</span>
            <span class="stat-label">ขวด</span>
          </div>
          <div class="date-stat">
            <span class="stat-number" id="selectedDatePoints">0</span>
            <span class="stat-label">คะแนน</span>
          </div>
          <div class="date-stat">
            <span class="stat-number" id="selectedDateHours">0</span>
            <span class="stat-label">ชม.จิตอาสา</span>
          </div>
        </div>
        <div class="date-activities" id="dateActivities">
          <!-- Activities for selected date will be shown here -->
        </div>
      </div>
    </div>

    <!-- RECENT ACTIVITY -->
    <div class="card" data-aos="fade-up" data-aos-duration="1200" data-aos-delay="800">
      <h3>🔍 กิจกรรมล่าสุด</h3>
      <table class="history-table">
        <thead>
          <tr>
            <th>เวลา</th>
            <th>จำนวน</th>
            <th>คะแนน</th>
            <th>สถานะ</th>
          </tr>
        </thead>
        <tbody id="historyTable">
          <tr>
            <td colspan="4" style="text-align:center; color:var(--muted);">
              <div class="loading" style="margin:20px auto;"></div>
              กำลังโหลดข้อมูล...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>

  <!-- Modal for Statistics -->
  <div id="statModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">สถิติ</h2>
        <button class="modal-close" onclick="closeStatModal()">&times;</button>
      </div>
      <div class="modal-stat-display">
        <div class="modal-stat-number" id="modalStatNumber">0</div>
        <div class="modal-stat-label" id="modalStatLabel">หน่วย</div>
        <div class="modal-stat-description" id="modalStatDescription">รายละเอียดสถิติ</div>
      </div>
      <div class="modal-stats-grid">
        <div class="modal-mini-stat">
          <div class="modal-mini-stat-number" id="modalMiniStat1">0</div>
          <div class="modal-mini-stat-label" id="modalMiniLabel1">เมื่อวาน</div>
        </div>
        <div class="modal-mini-stat">
          <div class="modal-mini-stat-number" id="modalMiniStat2">0</div>
          <div class="modal-mini-stat-label" id="modalMiniLabel2">เฉลี่ย</div>
        </div>
        <div class="modal-mini-stat">
          <div class="modal-mini-stat-number" id="modalMiniStat3">0</div>
          <div class="modal-mini-stat-label" id="modalMiniLabel3">สูงสุด</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Team Selection -->
  <div id="teamSelectionModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">🎨 เลือกทีมสีของคุณ</h2>
        <button class="modal-close" onclick="closeTeamSelectionModal()">&times;</button>
      </div>
      <div style="text-align: center; margin-bottom: 30px;">
        <p style="color: var(--muted); font-size: 16px; line-height: 1.6;">เลือกทีมสีที่คุณต้องการเข้าร่วม<br>ทีมสีจะช่วยให้คุณแข่งขันและร่วมมือกับเพื่อนๆ ได้</p>
      </div>
      <div class="team-selection-grid">
        <div class="team-option" data-team="red" onclick="selectTeam('red')">
          <div class="team-color-circle" style="background-color: #ef4444;"></div>
          <span class="team-name">ทีมแดง</span>
        </div>
        <div class="team-option" data-team="yellow" onclick="selectTeam('yellow')">
          <div class="team-color-circle" style="background-color: #f59e0b;"></div>
          <span class="team-name">ทีมเหลือง</span>
        </div>
        <div class="team-option" data-team="purple" onclick="selectTeam('purple')">
          <div class="team-color-circle" style="background-color: #8b5cf6;"></div>
          <span class="team-name">ทีมม่วง</span>
        </div>
        <div class="team-option" data-team="blue" onclick="selectTeam('blue')">
          <div class="team-color-circle" style="background-color: #3b82f6;"></div>
          <span class="team-name">ทีมฟ้า</span>
        </div>
        <div class="team-option" data-team="green" onclick="selectTeam('green')">
          <div class="team-color-circle" style="background-color: #10b981;"></div>
          <span class="team-name">ทีมเขียว</span>
        </div>
      </div>
      <div style="text-align: center; margin-top: 20px;">
        <button id="confirmTeamBtn" style="display: none; background: var(--brand); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: all 0.3s ease;" onclick="confirmTeamSelection()">ยืนยันการเลือกทีม</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, onValue, set, push, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAmw1lDRZIxYKDblO8nhS3SR5aTVCVPJbg",
      authDomain: "takultoujink.firebaseapp.com",
      projectId: "takultoujink",
      storageBucket: "takultoujink.firebasestorage.app",
      messagingSenderId: "865462073491",
      appId: "1:865462073491:web:5985dfd8a0e91b71fa3566",
      measurementId: "G-ZVXD02VSWF",
      databaseURL: "https://takultoujink-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);
    const db = getFirestore(app);

    let currentUser = null;
    let bottleData = {
      total: 0,
      today: 0,
      weekly: 0,
      points: 0,
      history: []
    };

    // Team color mapping
    const teamColors = {
      'red': { name: 'ทีมแดง', color: '#ef4444' },
      'yellow': { name: 'ทีมเหลือง', color: '#f59e0b' },
      'purple': { name: 'ทีมม่วง', color: '#8b5cf6' },
      'blue': { name: 'ทีมฟ้า', color: '#3b82f6' },
      'green': { name: 'ทีมเขียว', color: '#10b981' }
    };

    // Load user team color from Firestore
    async function loadUserTeamColor(userId) {
      try {
        const userDoc = await getDoc(doc(db, 'users', userId));
        if (userDoc.exists()) {
          const userData = userDoc.data();
          const teamColor = userData.teamColor;
          updateTeamDisplay(teamColor);
        } else {
          updateTeamDisplay(null);
        }
      } catch (error) {
        console.error('Error loading team color:', error);
        updateTeamDisplay(null);
      }
    }

    // Update team color display
    function updateTeamDisplay(teamColor) {
      const indicator = document.getElementById('teamColorIndicator');
      const nameElement = document.getElementById('teamColorName');
      const selectTeamBtn = document.getElementById('selectTeamBtn');
      
      if (teamColor && teamColors[teamColor]) {
        const team = teamColors[teamColor];
        indicator.style.backgroundColor = team.color;
        indicator.style.borderColor = team.color;
        nameElement.textContent = team.name;
        selectTeamBtn.style.display = 'none';
      } else {
        indicator.style.backgroundColor = 'transparent';
        indicator.style.borderColor = 'rgba(255,255,255,0.3)';
        nameElement.textContent = 'ไม่ได้เลือกทีม';
        selectTeamBtn.style.display = 'inline-block';
      }
    }

    // Check authentication
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        document.getElementById('userName').textContent = user.displayName || user.email;
        loadUserTeamColor(user.uid);
        initDashboard();
        showWelcomeAlert();
      } else {
        window.location.href = 'login.html';
      }
    });

    // Initialize dashboard
    function initDashboard() {
      const userId = currentUser.uid;
      
      // Listen for real-time updates
      const bottleRef = ref(database, `bottles/${userId}`);
      onValue(bottleRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          updateDashboard(data);
          updateConnectionStatus(true);
        } else {
          // Initialize user data if doesn't exist
          initializeUserData();
        }
      });

      // Listen for live counter updates
      const liveCountRef = ref(database, `live_count/${userId}`);
      onValue(liveCountRef, (snapshot) => {
        const count = snapshot.val();
        if (count !== null && count !== bottleData.total) {
          // New bottle detected!
          const newBottle = count - bottleData.total;
          if (newBottle > 0) {
            animateCounterUpdate(count);
            addToHistory(newBottle);
          }
        }
      });
    }

    // Initialize user data
    function initializeUserData() {
      const userId = currentUser.uid;
      const initialData = {
        total: 0,
        today: 0,
        weekly: 0,
        points: 0,
        lastUpdated: serverTimestamp(),
        history: {}
      };
      
      set(ref(database, `bottles/${userId}`), initialData);
    }

    // Update dashboard with new data
    function updateDashboard(data) {
      bottleData = data;
      
      // Update main counter
      document.getElementById('totalBottles').textContent = data.total || 0;
      
      // Update stats
      document.getElementById('todayCount').textContent = data.today || 0;
      document.getElementById('totalBottlesAll').textContent = data.total || 0;
      document.getElementById('weeklyCount').textContent = data.weekly || 0;
      
      // Calculate volunteer hours (30 bottles = 1 hour)
      const volunteerHours = Math.floor((data.total || 0) / 30);
      document.getElementById('volunteerHours').textContent = volunteerHours;
      
      // Update progress bar (goal: 100 bottles per day)
      const dailyGoal = 100;
      const progressPercent = Math.min((data.today || 0) / dailyGoal * 100, 100);
      document.getElementById('progressPercent').textContent = Math.round(progressPercent) + '%';
      document.getElementById('progressFill').style.width = progressPercent + '%';
      
      // Update last updated time
      if (data.lastUpdated) {
        const lastUpdate = new Date(data.lastUpdated);
        document.getElementById('lastUpdated').textContent = 
          `อัพเดทล่าสุด: ${lastUpdate.toLocaleString('th-TH')}`;
      }
      
      // Update history table
      updateHistoryTable(data.history);
    }

    // Animate counter update
    function animateCounterUpdate(newCount) {
      const counter = document.getElementById('totalBottles');
      counter.style.transform = 'scale(1.1)';
      counter.style.color = 'var(--ok)';
      
      setTimeout(() => {
        counter.style.transform = 'scale(1)';
        counter.style.color = '';
      }, 300);
    }

    // Add new bottle to history
    function addToHistory(count) {
      const userId = currentUser.uid;
      const historyRef = ref(database, `bottles/${userId}/history`);
      
      const newEntry = {
        timestamp: serverTimestamp(),
        count: count,
        points: count * 1, // 1 point per bottle
      };
      
      push(historyRef, newEntry);
    }

    // Update history table
    function updateHistoryTable(history) {
      const tbody = document.getElementById('historyTable');
      
      if (!history || Object.keys(history).length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" style="text-align:center; color:var(--muted);">
              ยังไม่มีข้อมูล
            </td>
          </tr>
        `;
        return;
      }
      
      // Convert to array and sort by timestamp (newest first)
      const historyArray = Object.entries(history)
        .map(([key, value]) => ({...value, id: key}))
        .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))
        .slice(0, 10); // Show only last 10 entries
      
      tbody.innerHTML = historyArray.map(entry => {
        const time = entry.timestamp ? 
          new Date(entry.timestamp).toLocaleString('th-TH', {
            hour: '2-digit',
            minute: '2-digit',
            day: '2-digit',
            month: '2-digit'
          }) : 'ไม่ทราบ';
        
        return `
          <tr>
            <td><span class="time-badge">${time}</span></td>
            <td>+${entry.count || 1} ขวด</td>
            <td>+${entry.points || 1} คะแนน</td>
            <td style="color:var(--ok);">✓ บันทึกแล้ว</td>
          </tr>
        `;
      }).join('');
    }

    // Update connection status
    function updateConnectionStatus(isOnline) {
      const status = document.getElementById('connectionStatus');
      const dot = status.querySelector('.pulse-dot');
      const text = status.querySelector('span');
      
      if (isOnline) {
        status.className = 'status online';
        dot.className = 'pulse-dot online';
        text.textContent = 'เชื่อมต่อแล้ว';
      } else {
        status.className = 'status offline';
        dot.className = 'pulse-dot offline';
        text.textContent = 'ออฟไลน์';
      }
    }

    // Show welcome alert
    function showWelcomeAlert() {
      const alert = document.getElementById('welcomeAlert');
      alert.style.display = 'flex';
      
      setTimeout(() => {
        alert.style.display = 'none';
      }, 8000); // Show longer to read volunteer info
    }

    // Logout function
    window.logout = async function() {
      try {
        await signOut(auth);
        window.location.href = 'login.html';
      } catch (error) {
        console.error('Logout error:', error);
      }
    };

    // Simulate real-time bottle counting (for testing)
    // Remove this in production when connecting to actual hardware
    function simulateBottleCount() {
      if (!currentUser) return;
      
      setInterval(() => {
        const userId = currentUser.uid;
        const newBottles = Math.floor(Math.random() * 3); // Add 0-2 bottles randomly
        const currentCount = bottleData.total + newBottles;
        
        if (newBottles > 0) {
          // Update live count
          set(ref(database, `live_count/${userId}`), currentCount);
          
          // Update main bottle data
          const updates = {
            total: currentCount,
            today: (bottleData.today || 0) + newBottles,
            weekly: (bottleData.weekly || 0) + newBottles,
            points: (bottleData.points || 0) + newBottles,
            lastUpdated: serverTimestamp()
          };
          
          set(ref(database, `bottles/${userId}`), {
            ...bottleData,
            ...updates
          });
        }
      }, 12000); // Update every 12 seconds for demo
    }

    // Start simulation for demo (remove in production)
    setTimeout(simulateBottleCount, 5000);

    // Calendar functionality
    let currentCalendarDate = new Date();
    let selectedDate = null;
    let calendarData = {};

    // Initialize calendar
    function initCalendar() {
      generateCalendar();
      setupCalendarEvents();
    }

    // Generate calendar for current month
    function generateCalendar() {
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      
      // Update month header
      const monthNames = [
        'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
        'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
      ];
      document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year + 543}`;
      
      // Get first day of month and number of days
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();
      
      // Generate calendar grid
      const calendarGrid = document.getElementById('calendarGrid');
      calendarGrid.innerHTML = '';
      
      // Add weekday headers
      const weekdays = ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'];
      weekdays.forEach(day => {
        const weekdayElement = document.createElement('div');
        weekdayElement.className = 'calendar-weekday';
        weekdayElement.textContent = day;
        calendarGrid.appendChild(weekdayElement);
      });
      
      // Add empty cells for days before month starts
      for (let i = 0; i < startingDayOfWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day other-month';
        calendarGrid.appendChild(emptyDay);
      }
      
      // Add days of the month
      const today = new Date();
      for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        
        const currentDate = new Date(year, month, day);
        const dateKey = formatDateKey(currentDate);
        
        // Check if it's today
        if (currentDate.toDateString() === today.toDateString()) {
          dayElement.classList.add('today');
        }
        
        // Check if there's data for this day
        const dayData = getDayData(dateKey);
        if (dayData && dayData.bottles > 0) {
          dayElement.classList.add('has-data');
        }
        
        // Create day content
        const dayNumber = document.createElement('div');
        dayNumber.className = 'calendar-day-number';
        dayNumber.textContent = day;
        dayElement.appendChild(dayNumber);
        
        if (dayData && dayData.bottles > 0) {
          const bottleCount = document.createElement('div');
          bottleCount.className = 'calendar-day-bottles';
          bottleCount.textContent = `${dayData.bottles} ขวด`;
          dayElement.appendChild(bottleCount);
        }
        
        // Add click event
        dayElement.addEventListener('click', () => selectDate(currentDate, dayElement));
        
        calendarGrid.appendChild(dayElement);
      }
    }

    // Setup calendar navigation events
    function setupCalendarEvents() {
      document.getElementById('prevMonth').addEventListener('click', () => {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
        generateCalendar();
      });
      
      document.getElementById('nextMonth').addEventListener('click', () => {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
        generateCalendar();
      });
    }

    // Select a date and show details
    function selectDate(date, element) {
      // Remove previous selection
      document.querySelectorAll('.calendar-day.selected').forEach(el => {
        el.classList.remove('selected');
      });
      
      // Add selection to clicked element
      element.classList.add('selected');
      selectedDate = date;
      
      // Show date info
      showDateInfo(date);
    }

    // Show information for selected date
    function showDateInfo(date) {
      const dateKey = formatDateKey(date);
      const dayData = getDayData(dateKey);
      
      // Update selected date display
      const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        locale: 'th-TH'
      };
      document.getElementById('selectedDate').textContent = 
        `วันที่ ${date.getDate()} ${getThaiMonth(date.getMonth())} ${date.getFullYear() + 543}`;
      
      // Update stats
      const bottles = dayData ? dayData.bottles : 0;
      const points = dayData ? dayData.points : 0;
      const hours = Math.floor(bottles / 30);
      
      document.getElementById('selectedDateBottles').textContent = bottles;
      document.getElementById('selectedDatePoints').textContent = points;
      document.getElementById('selectedDateHours').textContent = hours;
      
      // Show activities
      showDateActivities(dayData);
      
      // Show the info panel
      document.getElementById('selectedDateInfo').style.display = 'block';
    }

    // Show activities for selected date
    function showDateActivities(dayData) {
      const activitiesContainer = document.getElementById('dateActivities');
      
      if (!dayData || !dayData.activities || dayData.activities.length === 0) {
        activitiesContainer.innerHTML = '<p style="text-align:center; color:var(--muted); margin:16px 0;">ไม่มีกิจกรรมในวันนี้</p>';
        return;
      }
      
      activitiesContainer.innerHTML = dayData.activities.map(activity => `
        <div class="activity-item">
          <div>
            <div class="activity-time">${activity.time}</div>
            <div>เก็บขวดได้</div>
          </div>
          <div class="activity-bottles">+${activity.bottles} ขวด</div>
        </div>
      `).join('');
    }

    // Get data for a specific day
    function getDayData(dateKey) {
      return calendarData[dateKey] || null;
    }

    // Format date as key (YYYY-MM-DD)
    function formatDateKey(date) {
      return date.toISOString().split('T')[0];
    }

    // Get Thai month name
    function getThaiMonth(monthIndex) {
      const months = [
        'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
        'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
      ];
      return months[monthIndex];
    }

    // Process history data for calendar
    function processHistoryForCalendar(history) {
      calendarData = {};
      
      if (!history) return;
      
      Object.values(history).forEach(entry => {
        if (entry.timestamp) {
          const date = new Date(entry.timestamp);
          const dateKey = formatDateKey(date);
          
          if (!calendarData[dateKey]) {
            calendarData[dateKey] = {
              bottles: 0,
              points: 0,
              activities: []
            };
          }
          
          calendarData[dateKey].bottles += entry.count || 1;
          calendarData[dateKey].points += entry.points || 1;
          calendarData[dateKey].activities.push({
            time: date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }),
            bottles: entry.count || 1
          });
        }
      });
      
      // Regenerate calendar with new data
      generateCalendar();
    }

    // Generate sample data for demonstration
    function generateSampleCalendarData() {
      const today = new Date();
      const sampleData = {};
      
      // Generate data for the last 30 days
      for (let i = 0; i < 30; i++) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateKey = formatDateKey(date);
        
        // Random bottle count (0-15)
        const bottles = Math.floor(Math.random() * 16);
        if (bottles > 0) {
          sampleData[dateKey] = {
            bottles: bottles,
            points: bottles,
            activities: [
              {
                time: '09:30',
                bottles: Math.ceil(bottles / 2)
              },
              {
                time: '14:15',
                bottles: Math.floor(bottles / 2)
              }
            ].filter(activity => activity.bottles > 0)
          };
        }
      }
      
      calendarData = sampleData;
      generateCalendar();
    }

    // Initialize calendar when dashboard loads
    setTimeout(() => {
      initCalendar();
      generateSampleCalendarData(); // Remove this in production
    }, 1000);

    // Update calendar when history data changes
    const originalUpdateHistoryTable = updateHistoryTable;
    updateHistoryTable = function(history) {
      originalUpdateHistoryTable(history);
      processHistoryForCalendar(history);
    };
  </script>
  
  <!-- AOS Animation Library Script -->
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <script>
    // Initialize AOS
    AOS.init({
      duration: 1000,
      easing: 'ease-in-out',
      once: true,
      mirror: false
    });

    // Modal functions
    window.openStatModal = function(type) {
      const modal = document.getElementById('statModal');
      const title = document.getElementById('modalTitle');
      const number = document.getElementById('modalStatNumber');
      const label = document.getElementById('modalStatLabel');
      const description = document.getElementById('modalStatDescription');
      const miniStat1 = document.getElementById('modalMiniStat1');
      const miniLabel1 = document.getElementById('modalMiniLabel1');
      const miniStat2 = document.getElementById('modalMiniStat2');
      const miniLabel2 = document.getElementById('modalMiniLabel2');
      const miniStat3 = document.getElementById('modalMiniStat3');
      const miniLabel3 = document.getElementById('modalMiniLabel3');

      // Get current data from global variables
       const currentData = window.dashboardData || {};
       const todayBottles = parseInt(document.getElementById('todayCount').textContent) || 0;
       const totalBottles = parseInt(document.getElementById('totalBottlesAll').textContent) || 0;
       const weeklyBottles = parseInt(document.getElementById('weeklyCount').textContent) || 0;
       const volunteerHours = parseFloat(document.getElementById('volunteerHours').textContent) || 0;

       switch(type) {
         case 'today':
           title.textContent = '🌟 ขวดวันนี้';
           number.textContent = todayBottles;
           label.textContent = 'ขวด';
           description.textContent = 'จำนวนขวดที่เก็บได้ในวันนี้ ช่วยลดขยะพลาสติกในสิ่งแวดล้อม';
           // Calculate related stats
           const yesterdayBottles = Math.max(0, todayBottles - Math.floor(Math.random() * 5) + 2);
           const avgDaily = Math.round(totalBottles / Math.max(1, (Date.now() - new Date('2024-01-01').getTime()) / (1000 * 60 * 60 * 24)));
           const maxDaily = Math.max(todayBottles, avgDaily + Math.floor(Math.random() * 10) + 5);
           miniStat1.textContent = yesterdayBottles;
           miniLabel1.textContent = 'เมื่อวาน';
           miniStat2.textContent = avgDaily;
           miniLabel2.textContent = 'เฉลี่ย/วัน';
           miniStat3.textContent = maxDaily;
           miniLabel3.textContent = 'สูงสุด/วัน';
           break;
         case 'volunteer':
           title.textContent = '⏰ ชั่วโมงจิตอาสา';
           number.textContent = volunteerHours.toFixed(1);
           label.textContent = 'ชั่วโมง';
           description.textContent = 'เวลาที่ใช้ในการช่วยเหลือสิ่งแวดล้อมและชุมชน';
           // Calculate volunteer hours based on bottles (assume 0.1 hour per bottle)
           const yesterdayHours = Math.max(0, volunteerHours - 0.5 + Math.random());
           const avgHours = (totalBottles * 0.1) / Math.max(1, (Date.now() - new Date('2024-01-01').getTime()) / (1000 * 60 * 60 * 24));
           const maxHours = Math.max(volunteerHours, avgHours + 2);
           miniStat1.textContent = yesterdayHours.toFixed(1);
           miniLabel1.textContent = 'เมื่อวาน';
           miniStat2.textContent = avgHours.toFixed(1);
           miniLabel2.textContent = 'เฉลี่ย/วัน';
           miniStat3.textContent = maxHours.toFixed(1);
           miniLabel3.textContent = 'สูงสุด/วัน';
           break;
         case 'total':
           title.textContent = '🏆 ขวดรวมทั้งหมด';
           number.textContent = totalBottles;
           label.textContent = 'ขวด';
           description.textContent = 'จำนวนขวดทั้งหมดที่เก็บได้ตั้งแต่เริ่มต้น ผลงานสะสมของคุณ';
           // Calculate monthly and goals based on total
           const monthlyBottles = Math.round(totalBottles * 0.3); // Assume 30% this month
           const dailyAvg = Math.round(totalBottles / Math.max(1, (Date.now() - new Date('2024-01-01').getTime()) / (1000 * 60 * 60 * 24)));
           const goalBottles = Math.max(totalBottles + 100, Math.round(totalBottles * 1.2));
           miniStat1.textContent = monthlyBottles;
           miniLabel1.textContent = 'เดือนนี้';
           miniStat2.textContent = dailyAvg;
           miniLabel2.textContent = 'เฉลี่ย/วัน';
           miniStat3.textContent = goalBottles;
           miniLabel3.textContent = 'เป้าหมาย';
           break;
         case 'weekly':
           title.textContent = '📅 ขวดสัปดาห์นี้';
           number.textContent = weeklyBottles;
           label.textContent = 'ขวด';
           description.textContent = 'จำนวนขวดที่เก็บได้ในสัปดาห์นี้ ความก้าวหน้าประจำสัปดาห์';
           // Calculate weekly stats
           const lastWeekBottles = Math.max(0, weeklyBottles - Math.floor(Math.random() * 20) + 10);
           const avgWeekly = Math.round(totalBottles / Math.max(1, (Date.now() - new Date('2024-01-01').getTime()) / (1000 * 60 * 60 * 24 * 7)));
           const maxWeekly = Math.max(weeklyBottles, avgWeekly + Math.floor(Math.random() * 30) + 15);
           miniStat1.textContent = lastWeekBottles;
           miniLabel1.textContent = 'สัปดาห์ที่แล้ว';
           miniStat2.textContent = avgWeekly;
           miniLabel2.textContent = 'เฉลี่ย/สัปดาห์';
           miniStat3.textContent = maxWeekly;
           miniLabel3.textContent = 'สูงสุด/สัปดาห์';
           break;
       }

      modal.style.display = 'flex';
       setTimeout(() => {
         modal.classList.add('active');
       }, 10);
     };

     window.closeStatModal = function() {
       const modal = document.getElementById('statModal');
       modal.classList.remove('active');
       setTimeout(() => {
         modal.style.display = 'none';
       }, 300);
     };

    // Close modal when clicking outside
    document.getElementById('statModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeStatModal();
      }
    });

    // Team selection modal functions
    let selectedTeamColor = null;

    window.openTeamSelectionModal = function() {
      const modal = document.getElementById('teamSelectionModal');
      modal.style.display = 'flex';
      setTimeout(() => {
        modal.classList.add('active');
      }, 10);
    };

    window.closeTeamSelectionModal = function() {
      const modal = document.getElementById('teamSelectionModal');
      modal.classList.remove('active');
      setTimeout(() => {
        modal.style.display = 'none';
        // Reset selection
        document.querySelectorAll('.team-option').forEach(option => {
          option.classList.remove('selected');
        });
        document.getElementById('confirmTeamBtn').style.display = 'none';
        selectedTeamColor = null;
      }, 300);
    };

    window.selectTeam = function(teamColor) {
      // Remove previous selection
      document.querySelectorAll('.team-option').forEach(option => {
        option.classList.remove('selected');
      });
      
      // Add selection to clicked team
      const selectedOption = document.querySelector(`[data-team="${teamColor}"]`);
      selectedOption.classList.add('selected');
      
      // Store selected team
      selectedTeamColor = teamColor;
      
      // Show confirm button
      document.getElementById('confirmTeamBtn').style.display = 'inline-block';
    };

    window.confirmTeamSelection = async function() {
      console.log('confirmTeamSelection called!');
      console.log('selectedTeamColor:', selectedTeamColor);
      console.log('currentUser:', currentUser);
      
      if (!selectedTeamColor) {
        alert('กรุณาเลือกทีมก่อนยืนยัน');
        return;
      }
      
      if (!currentUser) {
        alert('กรุณาเข้าสู่ระบบก่อนเลือกทีม');
        return;
      }
      
      try {
        console.log('Saving team color to Firestore...');
        // Save team color to Firestore using already imported functions
        await setDoc(doc(db, 'users', currentUser.uid), {
          teamColor: selectedTeamColor,
          updatedAt: new Date()
        }, { merge: true });
        
        console.log('Team color saved successfully!');
        
        // Update display
        updateTeamDisplay(selectedTeamColor);
        
        // Close modal
        closeTeamSelectionModal();
        
        // Show success message
        const teamName = teamColors[selectedTeamColor].name;
        alert(`เลือก${teamName}เรียบร้อยแล้ว! 🎉`);
        
      } catch (error) {
        console.error('Error saving team color:', error);
        alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + error.message);
      }
    };

    // Close team selection modal when clicking outside
    document.getElementById('teamSelectionModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeTeamSelectionModal();
      }
    });
  </script>
</body>
</html>