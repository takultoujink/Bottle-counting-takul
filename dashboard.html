<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>P2P</title>
  <meta name="description" content="Dashboard สำหรับติดตามจำนวนขวดแบบ Real-time" />
  
  <!-- AOS Animation Library -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" />
  <style>
    /* Bai Jamjuree Font Faces */
    @font-face {
      font-family: 'Bai Jamjuree';
      src: url('./fonts/BaiJamjuree-Regular.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
    }
    @font-face {
      font-family: 'Bai Jamjuree';
      src: url('./fonts/BaiJamjuree-Medium.ttf') format('truetype');
      font-weight: 500;
      font-style: normal;
    }
    @font-face {
      font-family: 'Bai Jamjuree';
      src: url('./fonts/BaiJamjuree-SemiBold.ttf') format('truetype');
      font-weight: 600;
      font-style: normal;
    }
    @font-face {
      font-family: 'Bai Jamjuree';
      src: url('./fonts/BaiJamjuree-Bold.ttf') format('truetype');
      font-weight: 700;
      font-style: normal;
    }
    @font-face {
      font-family: 'Bai Jamjuree';
      src: url('./fonts/BaiJamjuree-Light.ttf') format('truetype');
      font-weight: 300;
      font-style: normal;
    }
    @font-face {
      font-family: 'Bai Jamjuree';
      src: url('./fonts/BaiJamjuree-ExtraLight.ttf') format('truetype');
      font-weight: 200;
      font-style: normal;
    }

    :root{
      --bg: #0a0e1a;          /* พื้นหลังเข้มมาก */
      --bg-secondary: #111827; /* พื้นหลังรอง */
      --card: #1f2937;        /* การ์ดเข้ม */
      --text: #f9fafb;        /* ข้อความสว่าง */
      --muted: #9ca3af;       /* ข้อความรอง */
      --brand: #3b82f6;       /* สีน้ำเงิน */
      --brand-2: #06b6d4;     /* สีฟ้าเข้ม */
      --accent: #8b5cf6;      /* สีม่วง */
      --accent-2: #10b981;    /* สีเขียวมิ้นต์ */
      --accent-3: #f59e0b;    /* สีส้ม */
      --ok: #10b981;          /* สำเร็จ */
      --warn: #f59e0b;        /* เตือน */
      --error: #ef4444;       /* ผิดพลาด */
      --radius-xl: 20px;
      --radius: 12px;
      --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
      --shadow-soft: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
    }

    /* รีเซ็ตเล็กน้อย */
    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family: 'Bai Jamjuree', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans Thai", "Noto Sans", "Liberation Sans", sans-serif;
      color:var(--text); 
      background: 
        radial-gradient(1200px 600px at 10% 20%, rgba(59, 130, 246, 0.15), transparent 60%), 
        radial-gradient(1200px 800px at 90% 10%, rgba(6, 182, 212, 0.12), transparent 60%), 
        radial-gradient(800px 600px at 20% 90%, rgba(139, 92, 246, 0.1), transparent 50%), 
        linear-gradient(135deg, var(--bg) 0%, var(--bg-secondary) 100%);
      line-height:1.6; letter-spacing:.2px;
      animation: cosmic-drift 25s ease-in-out infinite;
      position: relative;
      overflow-x: hidden;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(2px 2px at 20px 30px, #fff, transparent),
        radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
        radial-gradient(1px 1px at 90px 40px, #fff, transparent),
        radial-gradient(1px 1px at 130px 80px, rgba(255,255,255,0.6), transparent),
        radial-gradient(2px 2px at 160px 30px, #fff, transparent),
        radial-gradient(1px 1px at 200px 90px, rgba(255,255,255,0.7), transparent),
        radial-gradient(2px 2px at 240px 50px, #fff, transparent),
        radial-gradient(1px 1px at 280px 10px, rgba(255,255,255,0.9), transparent),
        radial-gradient(1px 1px at 320px 70px, #fff, transparent),
        radial-gradient(2px 2px at 360px 40px, rgba(255,255,255,0.8), transparent);
      background-repeat: repeat;
      background-size: 400px 200px;
      animation: stars-twinkle 20s linear infinite;
      pointer-events: none;
      z-index: 1;
    }
    
    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(1px 1px at 50px 100px, rgba(255,255,255,0.5), transparent),
        radial-gradient(2px 2px at 100px 20px, rgba(255,255,255,0.7), transparent),
        radial-gradient(1px 1px at 150px 60px, #fff, transparent),
        radial-gradient(1px 1px at 200px 120px, rgba(255,255,255,0.6), transparent),
        radial-gradient(2px 2px at 250px 40px, rgba(255,255,255,0.8), transparent),
        radial-gradient(1px 1px at 300px 80px, #fff, transparent),
        radial-gradient(1px 1px at 350px 15px, rgba(255,255,255,0.9), transparent),
        radial-gradient(2px 2px at 380px 110px, rgba(255,255,255,0.7), transparent);
      background-repeat: repeat;
      background-size: 450px 180px;
      animation: stars-twinkle 25s linear infinite reverse;
      pointer-events: none;
      z-index: 1;
    }
    
    @keyframes cosmic-drift {
      0%, 100% { background-position: 0% 50%, 100% 50%, 0% 100%; }
      33% { background-position: 50% 0%, 50% 100%, 100% 50%; }
      66% { background-position: 100% 50%, 0% 50%, 50% 0%; }
    }
    
    @keyframes stars-twinkle {
      0% { 
        opacity: 0.3;
        transform: translateY(0px);
      }
      25% { 
        opacity: 1;
        transform: translateY(-10px);
      }
      50% { 
        opacity: 0.5;
        transform: translateY(-20px);
      }
      75% { 
        opacity: 0.8;
        transform: translateY(-30px);
      }
      100% { 
        opacity: 0.3;
        transform: translateY(-40px);
      }
    }
    
    /* Dashboard Watermark overlay */
    .container::before {
      content: '';
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 350px;
      height: 350px;
      background: url('ขวดโรงเรียน.jpg') no-repeat center center;
      background-size: contain;
      opacity: 0.03;
      z-index: 0;
      pointer-events: none;
      animation: cosmic-float 8s ease-in-out infinite;
    }
    
    @keyframes cosmic-float {
      0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
      50% { transform: translate(-50%, -50%) rotate(2deg) scale(1.02); }
    }
    
    /* Enhanced theme transition animations */
    @keyframes gradientShift {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }
    
    /* Theme transition class */
    .theme-transitioning {
      transition: all 0.7s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
    
    .theme-transitioning * {
      transition: all 0.7s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
    
    /* Enhanced card styles for bright mode */
     .card {
       transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
     }
     
     .card:hover {
       transform: translateY(-8px) scale(1.02);
       box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
     }
     
     /* Enhanced theme toggle button */
     .theme-toggle-btn {
       background: linear-gradient(135deg, var(--brand), var(--brand-2)) !important;
       color: #fff !important;
       border: none !important;
       border-radius: 12px !important;
       padding: 12px 20px !important;
       font-weight: 600 !important;
       display: flex !important;
       align-items: center !important;
       gap: 8px !important;
       transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
       box-shadow: 0 4px 15px rgba(124, 92, 255, 0.3) !important;
       position: relative !important;
       overflow: hidden !important;
     }
     
     .theme-toggle-btn::before {
       content: '';
       position: absolute;
       top: 0;
       left: -100%;
       width: 100%;
       height: 100%;
       background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
       transition: left 0.5s;
     }
     
     .theme-toggle-btn:hover {
       transform: translateY(-2px) scale(1.05) !important;
       box-shadow: 0 8px 25px rgba(124, 92, 255, 0.4) !important;
     }
     
     .theme-toggle-btn:hover::before {
       left: 100%;
     }
     
     .theme-toggle-btn:active {
       transform: translateY(0) scale(0.98) !important;
     }

    .container{ width:min(1200px, 95%); margin-inline:auto; position: relative; z-index: 2; }

    /* Navbar */
    .nav{ position:sticky; top:0; z-index:50; backdrop-filter:saturate(140%) blur(12px); background:rgba(31, 41, 55, 0.8); border-bottom:1px solid rgba(59, 130, 246, 0.3); box-shadow: var(--shadow-soft); }
    .nav-inner{ display:flex; align-items:center; justify-content:space-between; padding:14px 0; }
    .brand{ display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text); font-weight:700; }
    .logo{ width:36px; height:36px; border-radius:10px; background: conic-gradient(from 210deg at 50% 50%, var(--brand), var(--brand-2), var(--accent)); box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); animation: cosmic-pulse 4s ease-in-out infinite; }
    
    @keyframes cosmic-pulse {
      0%, 100% { transform: scale(1) rotate(0deg); box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
      50% { transform: scale(1.05) rotate(180deg); box-shadow: 0 0 40px rgba(59, 130, 246, 0.8); }
    }
    .logo-img{ width:40px; height:40px; border-radius:10px; object-fit:cover; box-shadow: var(--shadow-soft); transition: all 0.3s ease; }
    .logo-img:hover{ transform: scale(1.1) rotate(5deg); }
    .nav-actions{ display:flex; align-items:center; gap:12px; }
    .user-info{ display:flex; align-items:center; gap:8px; color:var(--muted); }
    
    /* Music Player Styles */
    .music-player {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 8px 12px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .music-player:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: var(--brand);
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(124, 92, 255, 0.2);
    }
    
    .music-info {
      display: flex;
      flex-direction: column;
      min-width: 120px;
    }
    
    .music-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .music-artist {
      font-size: 10px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .music-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .music-btn {
      background: var(--brand);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(124, 92, 255, 0.3);
    }
    
    .music-btn:hover {
      background: var(--brand-2);
      transform: scale(1.1);
      box-shadow: 0 4px 16px rgba(124, 92, 255, 0.5);
    }
    
    .music-btn:active {
      transform: scale(0.95);
    }
    
    .music-btn span {
      font-size: 14px;
      line-height: 1;
    }
    
    .volume-control {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .volume-icon {
      font-size: 14px;
      opacity: 0.8;
    }
    
    .volume-slider {
      width: 60px;
      height: 4px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      outline: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .volume-slider::-webkit-slider-thumb {
      appearance: none;
      width: 12px;
      height: 12px;
      background: var(--brand);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(124, 92, 255, 0.4);
      transition: all 0.3s ease;
    }
    
    .volume-slider::-webkit-slider-thumb:hover {
      background: var(--brand-2);
      transform: scale(1.2);
      box-shadow: 0 3px 10px rgba(124, 92, 255, 0.6);
    }
    
    .volume-slider::-moz-range-thumb {
      width: 12px;
      height: 12px;
      background: var(--brand);
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 6px rgba(124, 92, 255, 0.4);
    }
    
    /* Mobile Navigation Styles */
    .mobile-nav-toggle {
      display: none;
      background: none;
      border: none;
      color: var(--text);
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .mobile-nav-toggle:hover {
      background: rgba(59, 130, 246, 0.1);
      transform: scale(1.1);
    }
    
    .nav-actions.mobile-hidden {
      display: none;
    }
    
    .nav-actions.mobile-visible {
      display: flex;
      position: fixed;
      top: 80px;
      left: 0;
      right: 0;
      background: var(--card);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 0 0 16px 16px;
      box-shadow: var(--shadow);
      z-index: 1000;
      padding: 20px;
      flex-direction: column;
      gap: 16px;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Responsive Design for Music Player */
    @media (max-width: 768px) {
      .mobile-nav-toggle {
        display: block;
      }
      
      .nav-actions {
        display: none;
      }
      
      .nav-inner {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
      
      .music-player {
        gap: 8px;
        padding: 6px 8px;
        order: 1;
      }
      
      .music-info {
        min-width: 80px;
      }
      
      .music-title {
        font-size: 11px;
      }
      
      .music-artist {
        font-size: 9px;
      }
      
      .music-btn {
        width: 28px;
        height: 28px;
      }
      
      .volume-slider {
        width: 40px;
      }
      
      .user-info {
        order: 2;
        flex-direction: row;
        gap: 8px;
        align-items: center;
      }
      
      .btn-logout {
        order: 3;
        padding: 8px 12px;
        font-size: 12px;
      }
    }
    
    /* Animation for playing state */
    .music-player.playing .music-title {
      animation: music-pulse 2s infinite;
    }
    
    @keyframes music-pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }
    .avatar{ width:36px; height:36px; border-radius:50%; background:linear-gradient(135deg, var(--brand), var(--brand-2), var(--accent)); border:2px solid rgba(59, 130, 246, 0.4); transition:all .3s ease; box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); }
    .avatar:hover{ transform:scale(1.1) rotate(5deg); border-color:var(--brand); box-shadow: 0 0 25px rgba(59, 130, 246, 0.6); }
    .btn-logout{ appearance:none; border:1px solid rgba(239,68,68,.4); background:linear-gradient(135deg, rgba(239,68,68,.15), rgba(251,113,133,.15)); color:var(--error); padding:10px 16px; border-radius:12px; cursor:pointer; font-size:14px; font-weight:600; transition:all .3s ease; box-shadow: 0 0 10px rgba(239,68,68,0.2); }
    .btn-logout:hover{ background:linear-gradient(135deg, var(--error), var(--accent)); border-color:var(--error); color:white; transform:scale(1.05); box-shadow: 0 0 20px rgba(239,68,68,0.5); }

    /* Header */
    .header{ padding:32px 0 24px; text-align:center; }
    .header h1{ margin:0; font-size: clamp(32px, 5vw, 42px); font-weight:800; color: var(--text); text-shadow: 0 0 20px var(--brand), 0 0 40px var(--accent); animation: cyber-text 3s ease-in-out infinite; }
    .header p{ color:var(--muted); margin:8px 0 0; font-size:1.1rem; }
    
    @keyframes cyber-text {
      0%, 100% { text-shadow: 0 0 20px var(--brand), 0 0 40px var(--accent); }
      50% { text-shadow: 0 0 30px var(--brand), 0 0 60px var(--accent), 0 0 80px var(--brand-2); }
    }

    /* Status indicator */
    .status{ display:inline-flex; align-items:center; gap:8px; padding:8px 16px; border-radius:999px; font-size:14px; margin-top:12px; box-shadow: var(--shadow-soft); }
    .status.online{ background:linear-gradient(135deg, rgba(16,185,129,.2), rgba(6,182,212,.2)); border:1px solid rgba(16,185,129,.4); color:var(--ok); box-shadow: 0 0 15px rgba(16,185,129,0.3); }
    .status.offline{ background:linear-gradient(135deg, rgba(239,68,68,.2), rgba(251,113,133,.2)); border:1px solid rgba(239,68,68,.4); color:var(--error); box-shadow: 0 0 15px rgba(239,68,68,0.3); }
    .pulse-dot{ width:10px; height:10px; border-radius:50%; }
    .pulse-dot.online{ background:var(--ok); animation: neon-pulse 2s infinite; box-shadow: 0 0 10px var(--ok); }
    .pulse-dot.offline{ background:var(--error); animation: neon-pulse 2s infinite; box-shadow: 0 0 10px var(--error); }

    @keyframes neon-pulse {
      0%, 100% { opacity: 1; transform: scale(1); box-shadow: 0 0 10px currentColor; }
      50% { opacity: 0.8; transform: scale(1.3); box-shadow: 0 0 20px currentColor, 0 0 30px currentColor; }
    }

    /* Main grid */
    .dashboard-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:24px; margin-bottom:32px; }
    
    /* Cards */
    .card{ background: var(--card); border:1px solid rgba(59, 130, 246, 0.2); border-radius: var(--radius-xl); padding:28px; box-shadow: var(--shadow); position:relative; overflow:hidden; transition:all .3s ease; }
    .card::before{ content:''; position:absolute; top:0; left:0; right:0; height:2px; background:linear-gradient(90deg, var(--brand), var(--brand-2), var(--accent)); box-shadow: 0 0 10px var(--brand); }
    .card:hover{ transform:translateY(-6px) scale(1.02); box-shadow:0 25px 50px rgba(59, 130, 246, 0.3), 0 0 30px rgba(59, 130, 246, 0.2); animation: cyber-float 0.5s ease-in-out; }
    
    @keyframes cyber-float {
      0%, 100% { transform: translateY(-6px) scale(1.02) rotateX(0deg); }
      50% { transform: translateY(-8px) scale(1.03) rotateX(5deg); }
    }
    .card h3{ margin:0 0 16px; font-size:18px; color:var(--muted); display:flex; align-items:center; gap:8px; }

    /* Counter card */
    .counter-main{ text-align:center; }
    .bottle-count{ font-size: clamp(52px, 9vw, 80px); font-weight:900; margin:16px 0; color: var(--text); text-shadow: 0 0 30px var(--brand), 0 0 60px var(--accent); animation: hologram-glow 3s ease-in-out infinite; }
    
    @keyframes hologram-glow {
      0%, 100% { text-shadow: 0 0 30px var(--brand), 0 0 60px var(--accent); }
      50% { text-shadow: 0 0 50px var(--brand), 0 0 100px var(--accent), 0 0 150px var(--brand-2); }
    }
    .bottle-icon{ font-size:52px; margin-bottom:12px; animation: cosmic-orbit 6s ease-in-out infinite; }
    
    @keyframes cosmic-orbit {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      33% { transform: translateY(-8px) rotate(120deg); }
      66% { transform: translateY(-4px) rotate(240deg); }
    }
    .last-updated{ color:var(--muted); font-size:14px; margin-top:8px; }

    /* Stats grid */
    .stats-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
    .stat-item{ background:var(--card); border:1px solid rgba(59, 130, 246, 0.2); border-radius:16px; padding:20px; text-align:center; position:relative; overflow:hidden; transition:all .3s ease; }
    .stat-item::before{ content:''; position:absolute; top:0; left:0; right:0; height:2px; background:linear-gradient(90deg, var(--brand), var(--brand-2), var(--accent)); box-shadow: 0 0 8px var(--brand); }
    .stat-item:hover{ transform:translateY(-4px) scale(1.05); box-shadow:var(--shadow), 0 0 25px rgba(59, 130, 246, 0.3); animation: data-pulse 0.6s ease; }
    .stat-number{ font-size:28px; font-weight:800; margin-bottom:6px; color: var(--text); text-shadow: 0 0 15px var(--brand); }
    .stat-label{ font-size:13px; color:var(--muted); font-weight:500; }

    /* History table */
    .history-table{ width:100%; border-collapse:collapse; }
    .history-table th{ text-align:left; padding:12px 8px; border-bottom:1px solid rgba(255,255,255,.1); color:var(--muted); font-size:14px; }
    .history-table td{ padding:12px 8px; border-bottom:1px solid rgba(255,255,255,.05); }
    .time-badge{ background:linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(6, 182, 212, 0.15)); padding:6px 12px; border-radius:8px; font-size:12px; border:1px solid rgba(59, 130, 246, 0.3); color:var(--brand); font-weight:500; box-shadow: 0 0 8px rgba(59, 130, 246, 0.2); }

    /* Progress bar */
    .progress-container{ margin:16px 0; }
    .progress-label{ display:flex; justify-content:space-between; margin-bottom:8px; font-size:14px; }
    .progress-bar{ height:8px; background:rgba(255,255,255,.1); border-radius:4px; overflow:hidden; }
    .progress-fill{ height:100%; background:linear-gradient(90deg, var(--brand), var(--brand-2), var(--accent)); transition: width 0.3s ease; border-radius:4px; position:relative; overflow:hidden; box-shadow: 0 0 10px var(--brand); }
    .progress-fill::after{ content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background:linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: data-stream 1.5s infinite; }
    
    @keyframes data-stream {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    
    @keyframes data-pulse {
      0%, 100% { transform: translateY(-4px) scale(1.05); }
      50% { transform: translateY(-6px) scale(1.08); }
    }

    /* Alert */
    .alert{ padding:16px; border-radius:12px; margin-bottom:24px; display:flex; align-items:center; gap:12px; }
    .alert.success{ background:rgba(16,185,129,.15); border:1px solid rgba(16,185,129,.4); color:var(--ok); box-shadow: 0 0 15px rgba(16,185,129,0.2); }
    .alert.warning{ background:rgba(245,158,11,.15); border:1px solid rgba(245,158,11,.4); color:var(--warn); box-shadow: 0 0 15px rgba(245,158,11,0.2); }

    /* Enhanced Mobile Responsive Design */
    
    /* Tablet and Small Desktop */
    @media (max-width: 1024px) {
      .container {
        padding: 0 20px;
      }
      
      .dashboard-grid {
        gap: 20px;
      }
      
      .card {
        padding: 24px;
      }
    }
    
    /* Tablet Portrait */
    @media (max-width: 800px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      
      .card {
        padding: 20px;
      }
      
      .bottle-count {
        font-size: clamp(40px, 8vw, 60px);
      }
      
      .header h1 {
        font-size: clamp(28px, 6vw, 36px);
      }
    }
    
    /* Mobile Landscape */
    @media (max-width: 768px) {
      .container {
        padding: 0 16px;
      }
      
      .nav {
        padding: 12px 0;
      }
      
      .nav-inner {
        flex-direction: column;
        gap: 12px;
        align-items: center;
      }
      
      .nav-actions {
        flex-direction: column;
        gap: 8px;
        width: 100%;
        align-items: center;
      }
      
      .user-info {
        flex-direction: row;
        gap: 12px;
        align-items: center;
      }
      
      .header {
        padding: 24px 0 20px;
      }
      
      .header h1 {
        font-size: clamp(24px, 5vw, 32px);
      }
      
      .header p {
        font-size: 1rem;
      }
      
      .card {
        padding: 16px;
        border-radius: 16px;
      }
      
      .bottle-img {
        max-width: 150px;
      }
      
      .history-table {
        font-size: 14px;
      }
      
      .history-table th,
      .history-table td {
        padding: 8px 4px;
      }
    }
    
    /* Mobile Portrait */
    @media (max-width: 480px) {
      .container {
        padding: 0 12px;
      }
      
      .nav-inner {
        padding: 0 12px;
      }
      
      .brand {
        font-size: 18px;
      }
      
      .logo-img {
        width: 32px;
        height: 32px;
      }
      
      .music-player {
        display: none; /* Hide music player on very small screens */
      }
      
      .nav-actions {
        flex-direction: row;
        justify-content: space-between;
        width: 100%;
      }
      
      .user-info {
        flex-direction: column;
        gap: 4px;
        align-items: flex-start;
        font-size: 12px;
      }
      
      .btn-logout {
        padding: 8px 12px;
        font-size: 12px;
      }
      
      .header {
        padding: 20px 0 16px;
      }
      
      .header h1 {
        font-size: clamp(20px, 6vw, 28px);
        line-height: 1.2;
      }
      
      .header p {
        font-size: 0.9rem;
        line-height: 1.4;
      }
      
      .dashboard-grid {
        gap: 12px;
      }
      
      .card {
        padding: 12px;
        border-radius: 12px;
      }
      
      .card h3 {
        font-size: 16px;
        margin-bottom: 12px;
      }
      
      .bottle-count {
        font-size: clamp(32px, 10vw, 48px);
        margin: 12px 0;
      }
      
      .bottle-img {
        max-width: 120px;
        margin-bottom: 10px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      
      .stat-item {
        padding: 12px;
        border-radius: 12px;
      }
      
      .stat-number {
        font-size: 20px;
      }
      
      .stat-label {
        font-size: 11px;
      }
      
      .history-table {
        font-size: 12px;
      }
      
      .history-table th,
      .history-table td {
        padding: 6px 2px;
      }
      
      .time-badge {
        padding: 4px 8px;
        font-size: 10px;
      }
      
      .alert {
        padding: 12px;
        font-size: 14px;
      }
      
      .progress-container {
        margin: 12px 0;
      }
      
      .progress-label {
        font-size: 12px;
      }
    }
    
    /* Very Small Mobile */
    @media (max-width: 360px) {
      .container {
        padding: 0 8px;
      }
      
      .nav-inner {
        padding: 0 8px;
      }
      
      .header h1 {
        font-size: clamp(18px, 7vw, 24px);
      }
      
      .header p {
        font-size: 0.8rem;
      }
      
      .card {
        padding: 10px;
      }
      
      .bottle-count {
        font-size: clamp(28px, 12vw, 40px);
      }
      
      .bottle-img {
        max-width: 100px;
      }
      
      .stat-number {
        font-size: 18px;
      }
      
      .stat-label {
        font-size: 10px;
      }
      
      .user-info {
        font-size: 11px;
      }
      
      .btn-logout {
        padding: 6px 10px;
        font-size: 11px;
      }
    }

    /* Loading animation */
    .loading{ display:inline-block; width:20px; height:20px; border:2px solid rgba(255,255,255,.2); border-radius:50%; border-top-color:var(--brand); animation:cyber-spin 1s ease-in-out infinite; box-shadow: 0 0 10px var(--brand); }
    @keyframes cyber-spin{ 
      0% { transform:rotate(0deg); box-shadow: 0 0 10px var(--brand); }
      50% { transform:rotate(180deg); box-shadow: 0 0 20px var(--brand), 0 0 30px var(--accent); }
      100% { transform:rotate(360deg); box-shadow: 0 0 10px var(--brand); }
    }
    
    /* Enhanced bottle image */
    .bottle-img {
      max-width: 200px;
      margin-bottom: 15px;
      transition: transform 0.5s ease;
      animation: cosmic-float 8s ease-in-out infinite;
      filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.3));
    }
    .bottle-img:hover {
      transform: scale(1.1) rotate(5deg);
      filter: brightness(1.2) drop-shadow(0 0 30px rgba(59, 130, 246, 0.6));
      animation-play-state: paused;
    }
    
    @keyframes cosmic-float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      33% { transform: translateY(-15px) rotate(120deg); }
      66% { transform: translateY(-8px) rotate(240deg); }
    }
    
    /* Enhanced card styles - removed duplicate as already defined above */
    
    /* Enhanced stat items - removed duplicate as already defined above */

    /* Modal Styles */
    .modal-overlay {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 1000;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      opacity: 0;
      visibility: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.08));
      border: 1px solid rgba(255,255,255,.2);
      border-radius: var(--radius-xl);
      padding: 40px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      transform: scale(0.7) translateY(50px);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      position: relative !important;
      margin: auto !important;
      top: auto !important;
      left: auto !important;
      right: auto !important;
      bottom: auto !important;
    }

    .modal-overlay.active .modal-content {
      transform: scale(1) translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,.1);
    }

    .modal-title {
      font-size: 28px;
      font-weight: 700;
      margin: 0;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .modal-close {
      background: rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.2);
      color: var(--text);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: var(--error);
      border-color: var(--error);
      transform: rotate(90deg);
    }

    .modal-stat-display {
      text-align: center;
      margin: 30px 0;
    }

    .modal-stat-number {
      font-size: 72px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
      animation: pulse-glow 2s infinite;
    }

    .modal-stat-label {
      font-size: 24px;
      color: var(--muted);
      margin-bottom: 20px;
    }

    .modal-stat-description {
      font-size: 16px;
      color: var(--text);
      line-height: 1.6;
      background: rgba(255,255,255,.05);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.1);
    }

    @keyframes pulse-glow {
      0%, 100% {
        filter: drop-shadow(0 0 10px rgba(124,92,255,0.3));
      }
      50% {
        filter: drop-shadow(0 0 20px rgba(124,92,255,0.6));
      }
    }

    .modal-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .modal-mini-stat {
      background: rgba(255,255,255,.05);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid rgba(255,255,255,.1);
    }

    .modal-mini-stat-number {
      font-size: 24px;
      font-weight: 700;
      color: var(--brand);
      margin-bottom: 5px;
    }

    .modal-mini-stat-label {
      font-size: 12px;
      color: var(--muted);
    }

    /* Modal Animation */
    .modal-overlay {
      opacity: 0;
      transform: scale(0.9);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .modal-overlay.active {
      opacity: 1;
      transform: scale(1);
    }

    .modal-content {
      transform: translateY(20px);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }

    /* Pulse animation for main stat number */
    .modal-stat-number {
      animation: pulse-glow 2s ease-in-out infinite;
    }

    @keyframes pulse-glow {
      0%, 100% {
        transform: scale(1);
        text-shadow: 0 0 20px rgba(74, 144, 226, 0.3);
      }
      50% {
        transform: scale(1.05);
        text-shadow: 0 0 30px rgba(74, 144, 226, 0.6);
      }
    }

    /* Calendar Styles */
    .calendar-container {
      margin-top: 12px;
    }
    
    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      padding: 0 6px;
    }
    
    .calendar-nav {
      background: rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.2);
      color: var(--text);
      width: 28px;
      height: 28px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .calendar-nav:hover {
      background: var(--brand);
      border-color: var(--brand);
      transform: scale(1.05);
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 3px;
      margin-bottom: 12px;
    }
    
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      min-height: 35px;
      font-size: 12px;
    }
    
    .calendar-day:hover {
      background: rgba(255,255,255,.1);
      transform: translateY(-2px);
    }
    
    .calendar-day.today {
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      color: white;
      font-weight: bold;
    }
    
    .calendar-day.has-data {
      background: rgba(52,211,153,.2);
      border-color: var(--ok);
    }
    
    .calendar-day.selected {
      background: var(--brand);
      color: white;
      transform: scale(1.05);
    }
    
    .calendar-day.other-month {
      opacity: 0.3;
      pointer-events: none;
    }
    
    .calendar-day-number {
      font-weight: 600;
      font-size: 11px;
    }
    
    .calendar-day-bottles {
      font-size: 8px;
      color: var(--ok);
      margin-top: 1px;
    }
    
    .calendar-weekday {
      text-align: center;
      padding: 6px 3px;
      font-size: 10px;
      color: var(--muted);
      font-weight: 600;
    }
    
    .selected-date-info {
      margin-top: 15px;
      padding: 12px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 10px;
    }
    
    .date-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin: 12px 0;
    }
    
    .date-stat {
      text-align: center;
      padding: 8px;
      background: rgba(255,255,255,.06);
      border-radius: 6px;
    }
    
    .date-stat .stat-number {
      display: block;
      font-size: 16px;
      font-weight: bold;
      color: var(--brand);
    }
    
    .date-stat .stat-label {
      font-size: 10px;
      color: var(--muted);
      margin-top: 3px;
    }
    
    .date-activities {
      margin-top: 12px;
    }
    
    .activity-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px;
      background: rgba(255,255,255,.04);
      border-radius: 5px;
      margin-bottom: 6px;
      font-size: 12px;
    }
    
    .activity-time {
      color: var(--muted);
      font-size: 10px;
    }
    
    .activity-bottles {
      color: var(--ok);
      font-weight: 600;
      font-size: 11px;
    }

    /* Team Selection Modal Styles */
    .team-selection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 12px;
      margin: 15px 0;
    }

    .team-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px;
      background: rgba(255,255,255,.05);
      border: 2px solid rgba(255,255,255,.1);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .team-option:hover {
      background: rgba(255,255,255,.1);
      border-color: rgba(255,255,255,.3);
      transform: translateY(-3px);
    }

    .team-option.selected {
      background: rgba(124,92,255,.2);
      border-color: var(--brand);
      transform: translateY(-3px) scale(1.03);
    }

    .team-color-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-bottom: 8px;
      box-shadow: 0 3px 8px rgba(0,0,0,.3);
      transition: all 0.3s ease;
    }

    .team-option:hover .team-color-circle {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,.4);
    }

    .team-name {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
    }

    .team-option.selected .team-name {
      color: var(--brand);
    }

    #confirmTeamBtn:hover {
      background: var(--brand-2);
      transform: translateY(-2px);
    }
    
    /* Search System Styles */
    .search-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    
    .search-overlay.active {
      display: flex;
    }
    
    .search-container {
      background: linear-gradient(135deg, rgba(31, 41, 55, 0.95) 0%, rgba(17, 24, 39, 0.95) 100%);
      border-radius: var(--radius-xl);
      padding: 32px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid rgba(59, 130, 246, 0.3);
      animation: slideUp 0.3s ease;
    }
    
    .search-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid rgba(59, 130, 246, 0.2);
    }
    
    .search-header h3 {
      margin: 0;
      color: var(--text);
      font-size: 1.5rem;
      font-weight: 600;
    }
    
    .search-close {
      background: none;
      border: none;
      font-size: 2rem;
      color: var(--muted);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.3s ease;
      line-height: 1;
    }
    
    .search-close:hover {
      background: rgba(59, 130, 246, 0.2);
      color: var(--brand);
      transform: rotate(90deg);
    }
    
    .search-input-container {
      position: relative;
      margin-bottom: 24px;
    }
    
    .search-input-container input {
      width: 100%;
      padding: 16px 50px 16px 20px;
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: var(--radius);
      font-size: 1rem;
      background: rgba(31, 41, 55, 0.8);
      color: var(--text);
      transition: all 0.3s ease;
    }
    
    .search-input-container input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      background: rgba(31, 41, 55, 0.95);
    }
    
    .search-input-container input::placeholder {
      color: var(--muted);
    }
    
    .search-icon {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.2rem;
      color: var(--muted);
      pointer-events: none;
    }
    
    .search-results {
      max-height: 400px;
      overflow-y: auto;
      border-radius: var(--radius);
    }
    
    .search-placeholder {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
    
    .search-placeholder-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .search-result-item {
      padding: 16px;
      border-radius: var(--radius);
      margin-bottom: 8px;
      background: rgba(31, 41, 55, 0.6);
      border: 1px solid rgba(59, 130, 246, 0.2);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .search-result-item:hover {
      background: rgba(59, 130, 246, 0.2);
      border-color: var(--brand);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .search-result-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
    }
    
    .search-result-content {
      flex: 1;
    }
    
    .search-result-title {
      font-weight: 600;
      color: var(--text);
      margin: 0 0 4px 0;
      font-size: 1rem;
    }
    
    .search-result-section {
      font-size: 0.85rem;
      color: var(--muted);
      margin: 0;
    }
    
    .search-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: var(--shadow-soft);
      transition: all 0.3s ease;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .search-btn:hover {
      transform: translateY(-4px) scale(1.1);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
    }
    
    .search-btn-icon {
      animation: pulse 2s infinite;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(50px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
    }
    
    /* Search Responsive */
    @media (max-width: 768px) {
      .search-container {
        width: 95%;
        padding: 24px;
        max-height: 85vh;
      }
      
      .search-header h3 {
        font-size: 1.3rem;
      }
      
      .search-btn {
        width: 50px;
        height: 50px;
        bottom: 20px;
        right: 20px;
        font-size: 1.3rem;
      }
    }
    
    @media (max-width: 480px) {
      .search-container {
        padding: 20px;
      }
      
      .search-input-container input {
        padding: 14px 45px 14px 16px;
        font-size: 0.9rem;
      }
      
      .search-result-item {
        padding: 12px;
      }
      
      .search-result-title {
        font-size: 0.9rem;
      }
    }
    
    /* Mobile Modal Responsive Styles */
    @media (max-width: 768px) {
      .modal {
        padding: 10px;
        align-items: flex-start;
        padding-top: 20px;
      }
      
      .modal-content {
        width: 95%;
        max-width: none;
        margin: 0;
        max-height: 90vh;
        overflow-y: auto;
        border-radius: 12px;
      }
      
      .modal-header {
        padding: 15px 20px;
        position: sticky;
        top: 0;
        background: white;
        z-index: 10;
        border-bottom: 1px solid #eee;
      }
      
      .modal-header h2 {
        font-size: 1.3rem;
        margin: 0;
      }
      
      .close {
        font-size: 28px;
        line-height: 1;
        padding: 5px;
        min-width: 35px;
        min-height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .modal-body {
        padding: 20px;
        max-height: calc(90vh - 120px);
        overflow-y: auto;
      }
      
      .modal-footer {
        padding: 15px 20px;
        position: sticky;
        bottom: 0;
        background: white;
        border-top: 1px solid #eee;
        margin-top: auto;
      }
      
      /* Team Selection Modal Mobile */
      .team-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .team-option {
        padding: 15px;
        text-align: center;
        border-radius: 8px;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .team-option h3 {
        font-size: 1.1rem;
        margin: 0;
      }
      
      /* Statistics Modal Mobile */
      .stats-modal-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .stats-modal-item {
        padding: 15px;
        text-align: center;
      }
      
      .stats-modal-value {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 5px;
      }
      
      .stats-modal-label {
        font-size: 0.9rem;
        color: #666;
      }
      
      /* Alert Mobile Styles */
      .alert {
        margin: 10px;
        padding: 12px 15px;
        border-radius: 8px;
        font-size: 0.9rem;
        line-height: 1.4;
      }
      
      .alert-warning {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
      }
      
      /* Form Elements Mobile */
      .form-group {
        margin-bottom: 15px;
      }
      
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        font-size: 0.9rem;
      }
      
      .form-control {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 16px; /* Prevents zoom on iOS */
        box-sizing: border-box;
      }
      
      .btn-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      
      .btn-group .btn {
        flex: 1;
        min-width: 120px;
      }
    }
    
    @media (max-width: 480px) {
      .modal-content {
        width: 98%;
        border-radius: 8px;
      }
      
      .modal-header,
      .modal-body,
      .modal-footer {
        padding: 15px;
      }
      
      .modal-header h2 {
        font-size: 1.2rem;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      .btn-group .btn {
         width: 100%;
         margin-bottom: 8px;
       }
     }
     
     /* Touch-Friendly Interactions */
     @media (max-width: 768px) {
       /* Increase button sizes for touch */
       .btn {
         min-height: 44px;
         padding: 12px 20px;
         font-size: 1rem;
         border-radius: 8px;
         touch-action: manipulation;
         -webkit-tap-highlight-color: transparent;
       }
       
       .btn-logout {
         min-height: 44px;
         padding: 12px 16px;
         font-size: 0.9rem;
       }
       
       .mobile-nav-toggle {
         min-height: 44px;
         min-width: 44px;
         padding: 10px;
         touch-action: manipulation;
         -webkit-tap-highlight-color: transparent;
       }
       
       /* Touch-friendly card interactions */
       .card {
         cursor: pointer;
         touch-action: manipulation;
         -webkit-tap-highlight-color: transparent;
         transition: transform 0.2s ease, box-shadow 0.2s ease;
       }
       
       .card:active {
         transform: scale(0.98);
       }
       
       /* Touch-friendly stat items */
       .stat-item {
         min-height: 60px;
         cursor: pointer;
         touch-action: manipulation;
         -webkit-tap-highlight-color: transparent;
         transition: transform 0.2s ease;
       }
       
       .stat-item:active {
         transform: scale(0.95);
       }
       
       /* Touch-friendly music controls */
       .music-btn {
         min-height: 44px;
         min-width: 44px;
         padding: 8px;
         touch-action: manipulation;
         -webkit-tap-highlight-color: transparent;
       }
       
       .volume-slider {
         min-height: 44px;
         touch-action: manipulation;
       }
       
       /* Touch-friendly close buttons */
       .close {
         min-height: 44px;
         min-width: 44px;
         touch-action: manipulation;
         -webkit-tap-highlight-color: transparent;
       }
       
       /* Touch-friendly team options */
       .team-option {
         min-height: 60px;
         cursor: pointer;
         touch-action: manipulation;
         -webkit-tap-highlight-color: transparent;
         transition: transform 0.2s ease, background-color 0.2s ease;
       }
       
       .team-option:active {
         transform: scale(0.95);
       }
       
       /* Touch-friendly search elements */
       .search-btn {
         min-height: 60px;
         min-width: 60px;
         touch-action: manipulation;
         -webkit-tap-highlight-color: transparent;
       }
       
       .search-close {
         min-height: 44px;
         min-width: 44px;
         touch-action: manipulation;
         -webkit-tap-highlight-color: transparent;
       }
       
       .search-result-item {
         min-height: 60px;
         cursor: pointer;
         touch-action: manipulation;
         -webkit-tap-highlight-color: transparent;
         transition: transform 0.2s ease, background-color 0.2s ease;
       }
       
       .search-result-item:active {
         transform: scale(0.98);
       }
       
       /* Touch-friendly form inputs */
       input, select, textarea {
         min-height: 44px;
         font-size: 16px; /* Prevents zoom on iOS */
         touch-action: manipulation;
       }
       
       /* Touch-friendly back to top button */
       .back-to-top-btn {
         min-height: 50px;
         min-width: 50px;
         touch-action: manipulation;
         -webkit-tap-highlight-color: transparent;
       }
       
       /* Improve touch scrolling */
       .modal-body,
       .search-results {
         -webkit-overflow-scrolling: touch;
         overscroll-behavior: contain;
       }
       
       /* Add visual feedback for touch */
       .btn:active,
       .music-btn:active,
       .mobile-nav-toggle:active,
       .close:active,
       .search-btn:active,
       .search-close:active,
       .back-to-top-btn:active {
         transform: scale(0.95);
         opacity: 0.8;
       }
       
       /* Prevent text selection on touch elements */
       .btn,
       .music-btn,
       .mobile-nav-toggle,
       .close,
       .search-btn,
       .search-close,
       .back-to-top-btn,
       .team-option,
       .stat-item,
       .card {
         -webkit-user-select: none;
         -moz-user-select: none;
         -ms-user-select: none;
         user-select: none;
       }
       
       /* Improve tap targets spacing */
       .nav-actions {
         gap: 12px;
       }
       
       .music-controls {
         gap: 12px;
       }
       
       .btn-group {
         gap: 12px;
       }
     }

  </style>
</head>
  <body>
    <!-- Search System -->
    <div id="searchOverlay" class="search-overlay">
      <div class="search-container">
        <div class="search-header">
          <h3>🔍 ค้นหาหัวข้อ</h3>
          <button class="search-close" onclick="closeSearch()">&times;</button>
        </div>
        <div class="search-input-container">
          <input type="text" id="searchInput" placeholder="พิมพ์เพื่อค้นหาหัวข้อ..." oninput="performSearch()">
          <div class="search-icon">🔍</div>
        </div>
        <div class="search-results" id="searchResults">
          <div class="search-placeholder">
            <div class="search-placeholder-icon">📝</div>
            <p>พิมพ์คำค้นหาเพื่อดูผลลัพธ์</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Search Button -->
    <button class="search-btn" onclick="openSearch()" title="ค้นหาหัวข้อ">
      <span class="search-btn-icon">🔍</span>
    </button>
  <!-- NAVBAR -->
  <nav class="nav" data-aos="fade-down" data-aos-duration="800">
    <div class="container nav-inner">
      <a class="brand" href="index.html">
        <img src="p2p.jpg" alt="P2P Logo" class="logo-img" style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: transform 0.3s ease; cursor: pointer;">
        <span>P2P</span>
      </a>
      
      <!-- Mobile Navigation Toggle -->
      <button class="mobile-nav-toggle" onclick="toggleMobileNav()" aria-label="เปิด/ปิดเมนู">
        <span id="hamburgerIcon">☰</span>
      </button>
      
      <div class="nav-actions" id="navActions">
        <!-- Music Player -->
        <div class="music-player" id="musicPlayer">
          <div class="music-info">
            <div class="music-title" id="musicTitle">🎵 เพลงพื้นหลัง</div>
            <div class="music-artist" id="musicArtist">ผ่อนคลาย</div>
          </div>
          <div class="music-controls">
            <button class="music-btn" id="playPauseBtn" onclick="toggleMusic()" title="เล่น/หยุดเพลง">
              <span id="playIcon">▶️</span>
            </button>
            <div class="volume-control">
              <span class="volume-icon">🔊</span>
              <input type="range" id="volumeSlider" min="0" max="100" value="50" class="volume-slider" onchange="changeVolume(this.value)">
            </div>
          </div>
          <audio id="backgroundMusic" loop preload="auto">
      <!-- Local music file -->
      <source src="ssvid.net--Playlist-아무-생각하기-싫을-때-가만히-듣기-좋은-잔잔한-재즈.mp3" type="audio/mpeg">
      <!-- Fallback: Generate tone via Web Audio API if files fail -->
    </audio>
        </div>
        
        <div class="user-info">
          <div class="avatar" aria-hidden="true"></div>
          <div style="display: flex; flex-direction: column; align-items: flex-start;">
            <span id="userName">Loading...</span>
            <div id="userTeam" style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--muted); margin-top: 2px;">
              <div id="teamColorIndicator" style="width: 12px; height: 12px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3);"></div>
              <span id="teamColorName">กำลังโหลด...</span>
              <button id="selectTeamBtn" style="display: none; background: var(--brand); color: white; border: none; padding: 2px 6px; border-radius: 4px; font-size: 10px; cursor: pointer; margin-left: 4px;" onclick="openTeamSelectionModal()">เลือกทีม</button>
            </div>
          </div>
          <button class="btn-logout theme-toggle-btn" onclick="toggleTheme()" title="เปลี่ยนระหว่างโหมดมืดและโหมดสว่าง">
          <span id="themeIcon">🌞</span>
          <span id="themeText">โหมดสว่าง</span>
        </button>
        </div>
        
        <button class="btn-logout" onclick="logout()">ออกจากระบบ</button>
      </div>
    </div>
  </nav>

  <!-- HEADER -->
  <header class="header">
    <div class="container" data-aos="fade-up" data-aos-duration="1000" data-aos-delay="200">
      <h1>P2P (Plastic to Point) - ระบบนับขวด</h1>
      <p>ติดตามจำนวนขวดที่นับได้แบบ Real-time และคำนวณชั่วโมงจิตอาสา</p>
      <div class="status" id="connectionStatus">
        <div class="pulse-dot offline"></div>
        <span>กำลังเชื่อมต่อ...</span>
      </div>
    </div>
  </header>

  <!-- MAIN DASHBOARD -->
  <main class="container">
    
    <!-- Alert for first time users -->
    <div class="alert success" id="welcomeAlert" style="display:none;">
      <span>🎉</span>
      <div>
        <strong>ยินดีต้อนรับ!</strong>
        <div>ระบบพร้อมทำงาน เครื่องนับขวดจะอัพเดทข้อมูลแบบ Real-time</div>
        <div style="margin-top:8px; font-size:13px; color:var(--muted);">
          💡 <strong>วิธีคำนวณจิตอาสา:</strong> ทุก 30 ขวด = 1 ชั่วโมงจิตอาสา
        </div>
        <button class="btn-logout theme-toggle-btn" style="margin-top:10px;" onclick="toggleTheme()" title="เปลี่ยนระหว่างโหมดมืดและโหมดสว่าง">
          <span id="themeIcon2">🌞</span>
          <span id="themeText2">โหมดสว่าง</span>
        </button>
        <script>
            // Enhanced Bright/Dark Theme Toggle with Beautiful Gradients & Animations
            function toggleTheme() {
            const root = document.documentElement;
            const isDark = root.style.getPropertyValue('--bg') === '#0b1020' || !root.style.getPropertyValue('--bg');
            
            // Add smooth transition class
            document.body.classList.add('theme-transitioning');
            
            if (isDark) {
              // Enhanced Bright Mode: Beautiful gradients, soft shadows, premium feel
              root.style.setProperty('--bg', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)');
              root.style.setProperty('--card', 'rgba(255, 255, 255, 0.95)');
              root.style.setProperty('--text', '#2d3748');
              root.style.setProperty('--muted', '#718096');
              root.style.setProperty('--brand', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)');
              root.style.setProperty('--brand-2', 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)');
              root.style.setProperty('--ok', 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)');
              root.style.setProperty('--warn', 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)');
              root.style.setProperty('--error', 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)');
              root.style.setProperty('--shadow', '0 20px 60px rgba(102, 126, 234, 0.15)');
              root.style.setProperty('--shadow-soft', '0 8px 32px rgba(118, 75, 162, 0.12)');
              root.style.setProperty('--radius-xl', '28px');
              root.style.setProperty('--radius', '20px');
              
              // Beautiful animated background
              document.body.style.background = 
              "linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #f5576c, #4facfe, #00f2fe)," +
              "radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3), transparent 50%)," +
              "radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3), transparent 50%)," +
              "radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2), transparent 50%)";
              document.body.style.backgroundSize = "400% 400%, 100% 100%, 100% 100%, 100% 100%";
              document.body.style.animation = "gradientShift 15s ease infinite";
              
              // Add floating particles effect
              createFloatingParticles();
              
              // Enhanced confetti with more colors
              if (!document.getElementById('confetti-canvas')) {
                const canvas = document.createElement('canvas');
                canvas.id = 'confetti-canvas';
                canvas.style.position = 'fixed';
                canvas.style.top = 0;
                canvas.style.left = 0;
                canvas.style.width = '100vw';
                canvas.style.height = '100vh';
                canvas.style.pointerEvents = 'none';
                canvas.style.zIndex = 9999;
                document.body.appendChild(canvas);
                launchEnhancedConfetti(canvas);
                setTimeout(() => {
                  if (canvas.parentNode) canvas.parentNode.removeChild(canvas);
                }, 2000);
              }
            } else {
              // Back to dark mode
              root.style.setProperty('--bg', '#0b1020');
              root.style.setProperty('--card', '#121833');
              root.style.setProperty('--text', '#e7eaf6');
              root.style.setProperty('--muted', '#aab1d6');
              root.style.setProperty('--brand', '#7c5cff');
              root.style.setProperty('--brand-2', '#22d3ee');
              root.style.setProperty('--ok', '#34d399');
              root.style.setProperty('--warn', '#fbbf24');
              root.style.setProperty('--error', '#ef4444');
              root.style.setProperty('--shadow', '0 10px 30px rgba(0,0,0,.35)');
              root.style.setProperty('--shadow-soft', '0 6px 18px rgba(0,0,0,.22)');
              root.style.setProperty('--radius-xl', '20px');
              root.style.setProperty('--radius', '14px');
              document.body.style.background = "";
              document.body.style.animation = "";
              
              // Remove floating particles
              removeFloatingParticles();
            }
            
            // Update theme toggle buttons
             updateThemeButtons(isDark);
             
             // Remove transition class after animation
             setTimeout(() => {
               document.body.classList.remove('theme-transitioning');
             }, 700);
             }
             
             // Update theme toggle button text and icons
             function updateThemeButtons(wasDark) {
               const icon1 = document.getElementById('themeIcon');
               const text1 = document.getElementById('themeText');
               const icon2 = document.getElementById('themeIcon2');
               const text2 = document.getElementById('themeText2');
               
               if (wasDark) {
                 // Now in bright mode
                 if (icon1) icon1.textContent = '🌙';
                 if (text1) text1.textContent = 'โหมดมืด';
                 if (icon2) icon2.textContent = '🌙';
                 if (text2) text2.textContent = 'โหมดมืด';
               } else {
                 // Now in dark mode
                 if (icon1) icon1.textContent = '🌞';
                 if (text1) text1.textContent = 'โหมดสว่าง';
                 if (icon2) icon2.textContent = '🌞';
                 if (text2) text2.textContent = 'โหมดสว่าง';
               }
             }

            // Enhanced confetti animation with more effects
            function launchEnhancedConfetti(canvas) {
            const ctx = canvas.getContext('2d');
            const W = window.innerWidth, H = window.innerHeight;
            canvas.width = W;
            canvas.height = H;
            const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#fa709a', '#fee140', '#ff9a9e', '#fecfef'];
            const shapes = ['circle', 'square', 'triangle', 'star'];
            const confetti = Array.from({length: 60}, () => ({
              x: Math.random() * W,
              y: Math.random() * -H,
              r: 4 + Math.random() * 12,
              d: 6 + Math.random() * 16,
              color: colors[Math.floor(Math.random() * colors.length)],
              shape: shapes[Math.floor(Math.random() * shapes.length)],
              tilt: Math.random() * 10 - 5,
              tiltAngle: 0,
              tiltAngleIncremental: (Math.random() * 0.1) + 0.05,
              opacity: 0.7 + Math.random() * 0.3
            }));
            let frame = 0;
            function draw() {
              ctx.clearRect(0, 0, W, H);
              confetti.forEach(c => {
                ctx.save();
                ctx.translate(c.x, c.y);
                ctx.rotate(c.tilt);
                ctx.fillStyle = c.color;
                ctx.globalAlpha = c.opacity;
                
                switch(c.shape) {
                  case 'circle':
                    ctx.beginPath();
                    ctx.arc(0, 0, c.r, 0, 2 * Math.PI);
                    ctx.fill();
                    break;
                  case 'square':
                    ctx.fillRect(-c.r/2, -c.r/2, c.r, c.r);
                    break;
                  case 'triangle':
                    ctx.beginPath();
                    ctx.moveTo(0, -c.r);
                    ctx.lineTo(-c.r, c.r);
                    ctx.lineTo(c.r, c.r);
                    ctx.closePath();
                    ctx.fill();
                    break;
                  case 'star':
                    drawStar(ctx, 0, 0, 5, c.r, c.r/2);
                    ctx.fill();
                    break;
                }
                ctx.restore();
              });
            }
            
            function drawStar(ctx, cx, cy, spikes, outerRadius, innerRadius) {
              let rot = Math.PI / 2 * 3;
              let x = cx;
              let y = cy;
              const step = Math.PI / spikes;
              
              ctx.beginPath();
              ctx.moveTo(cx, cy - outerRadius);
              for (let i = 0; i < spikes; i++) {
                x = cx + Math.cos(rot) * outerRadius;
                y = cy + Math.sin(rot) * outerRadius;
                ctx.lineTo(x, y);
                rot += step;
                
                x = cx + Math.cos(rot) * innerRadius;
                y = cy + Math.sin(rot) * innerRadius;
                ctx.lineTo(x, y);
                rot += step;
              }
              ctx.lineTo(cx, cy - outerRadius);
              ctx.closePath();
            }
            
            function update() {
              confetti.forEach(c => {
                c.y += Math.cos(frame/10 + c.d) + 3 + c.r/8;
                c.x += Math.sin(frame/20) * 1.5;
                c.tiltAngle += c.tiltAngleIncremental;
                c.tilt = Math.sin(c.tiltAngle) * 12;
                c.opacity = Math.max(0.3, c.opacity - 0.005);
                if (c.y > H + 30) {
                  c.y = -20;
                  c.x = Math.random() * W;
                  c.opacity = 0.7 + Math.random() * 0.3;
                }
              });
            }
            function animate() {
              frame++;
              update();
              draw();
              if (frame < 120) requestAnimationFrame(animate);
            }
            animate();
            }
            
            // Floating particles effect
            function createFloatingParticles() {
              if (document.getElementById('particles-canvas')) return;
              
              const canvas = document.createElement('canvas');
              canvas.id = 'particles-canvas';
              canvas.style.position = 'fixed';
              canvas.style.top = 0;
              canvas.style.left = 0;
              canvas.style.width = '100vw';
              canvas.style.height = '100vh';
              canvas.style.pointerEvents = 'none';
              canvas.style.zIndex = 1;
              canvas.style.opacity = '0.6';
              document.body.appendChild(canvas);
              
              const ctx = canvas.getContext('2d');
              const W = window.innerWidth, H = window.innerHeight;
              canvas.width = W;
              canvas.height = H;
              
              const particles = Array.from({length: 25}, () => ({
                x: Math.random() * W,
                y: Math.random() * H,
                r: 2 + Math.random() * 4,
                vx: (Math.random() - 0.5) * 0.5,
                vy: (Math.random() - 0.5) * 0.5,
                color: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe'][Math.floor(Math.random() * 6)],
                opacity: 0.3 + Math.random() * 0.4
              }));
              
              function animateParticles() {
                ctx.clearRect(0, 0, W, H);
                particles.forEach(p => {
                  p.x += p.vx;
                  p.y += p.vy;
                  
                  if (p.x < 0 || p.x > W) p.vx *= -1;
                  if (p.y < 0 || p.y > H) p.vy *= -1;
                  
                  ctx.beginPath();
                  ctx.arc(p.x, p.y, p.r, 0, 2 * Math.PI);
                  ctx.fillStyle = p.color;
                  ctx.globalAlpha = p.opacity;
                  ctx.fill();
                });
                requestAnimationFrame(animateParticles);
              }
              animateParticles();
            }
            
            function removeFloatingParticles() {
              const canvas = document.getElementById('particles-canvas');
              if (canvas && canvas.parentNode) {
                canvas.parentNode.removeChild(canvas);
              }
            }
        </script>
      </div>
    </div>

    <!-- Warning Alert for Bottle Instructions -->
    <div class="alert warning" style="margin-bottom: 24px;" data-aos="fade-up" data-aos-duration="800" data-aos-delay="300">
      <span>⚠️</span>
      <div>
        <strong>คำแนะนำสำคัญ!</strong>
        <div>กรุณาใส่ขวดทีละใบและโปรดให้ขวดว่างเปล่าก่อนใส่เพื่อการนับคะแนนที่มีประสิทธิภาพ</div>
        <div style="margin-top:8px; font-size:13px; color:var(--muted);">
          💡 <strong>เคล็ดลับ:</strong> ขวดที่ว่างเปล่าจะช่วยให้เซ็นเซอร์ทำงานได้แม่นยำมากขึ้น
        </div>
      </div>
    </div>

    <div class="dashboard-grid">
      
      <!-- MAIN COUNTER -->
      <div class="card counter-main" data-aos="zoom-in" data-aos-duration="1200" data-aos-delay="400">
        <img src="อิ่มถ่าย.jpg" alt="ขวดโรงเรียน" class="bottle-img" style="border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.15); transition: transform 0.3s ease; cursor: pointer;" onclick="openImageModal('อิ่มถ่าย.jpg', 'ขวดโรงเรียน')">
        <h3>จำนวนขวดทั้งหมด</h3>
        <div class="bottle-count" id="totalBottles">
          <span class="loading"></span>
        </div>
        <div class="last-updated" id="lastUpdated">กำลังโหลด...</div>
        
        <div class="progress-container">
          <div class="progress-label">
            <span>เป้าหมายวันนี้</span>
            <span id="progressPercent">0%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <!-- STATISTICS -->
      <div class="card" data-aos="fade-left" data-aos-duration="1000" data-aos-delay="600">
        <h3>📊 สถิติและจิตอาสา</h3>
        <div class="stats-grid">
          <div class="stat-item" data-aos="fade-up" data-aos-duration="800" data-aos-delay="800" onclick="openStatModal('today')">
            <div class="stat-number" id="todayCount">0</div>
            <div class="stat-label">ขวดวันนี้</div>
          </div>
          <div class="stat-item" data-aos="fade-up" data-aos-duration="800" data-aos-delay="900" onclick="openStatModal('volunteer')">
            <div class="stat-number" id="volunteerHours">0</div>
            <div class="stat-label">ชม.จิตอาสา</div>
          </div>
          <div class="stat-item" data-aos="fade-up" data-aos-duration="800" data-aos-delay="1000" onclick="openStatModal('total')">
            <div class="stat-number" id="totalBottlesAll">0</div>
            <div class="stat-label">ขวดรวมทั้งหมด</div>
          </div>
          <div class="stat-item" data-aos="fade-up" data-aos-duration="800" data-aos-delay="1100" onclick="openStatModal('weekly')">
            <div class="stat-number" id="weeklyCount">0</div>
            <div class="stat-label">ขวดสัปดาห์นี้</div>
          </div>
        </div>
        
        <!-- Volunteer Hours Info -->
        <div style="margin-top:16px; padding:12px; background:rgba(124,92,255,.1); border:1px solid rgba(124,92,255,.3); border-radius:8px; font-size:13px; text-align:center;">
          <strong>💡 วิธีการคำนวณ:</strong> ทุก 30 ขวด = 1 ชั่วโมงจิตอาสา
        </div>
      </div>
    </div>

    <!-- BOTTLE COLLECTION CALENDAR -->
    <div class="card" data-aos="fade-up" data-aos-duration="1200" data-aos-delay="1000">
      <h3>📅 ปฏิทินการเก็บขวด</h3>
      <div class="calendar-container">
        <div class="calendar-header">
          <button class="calendar-nav" id="prevMonth">‹</button>
          <h4 id="currentMonth">กำลังโหลด...</h4>
          <button class="calendar-nav" id="nextMonth">›</button>
        </div>
        <div class="calendar-grid" id="calendarGrid">
          <!-- Calendar will be generated here -->
        </div>
      </div>
      
      <!-- Selected Date Info -->
      <div class="selected-date-info" id="selectedDateInfo" style="display:none;">
        <h4 id="selectedDate">วันที่เลือก</h4>
        <div class="date-stats">
          <div class="date-stat">
            <span class="stat-number" id="selectedDateBottles">0</span>
            <span class="stat-label">ขวด</span>
          </div>
          <div class="date-stat">
            <span class="stat-number" id="selectedDatePoints">0</span>
            <span class="stat-label">คะแนน</span>
          </div>
          <div class="date-stat">
            <span class="stat-number" id="selectedDateHours">0</span>
            <span class="stat-label">ชม.จิตอาสา</span>
          </div>
        </div>
        <div class="date-activities" id="dateActivities">
          <!-- Activities for selected date will be shown here -->
        </div>
      </div>
    </div>

    <!-- RECENT ACTIVITY -->
    <div class="card" data-aos="fade-up" data-aos-duration="1200" data-aos-delay="800">
      <h3>🔍 กิจกรรมล่าสุด</h3>
      <table class="history-table">
        <thead>
          <tr>
            <th>เวลา</th>
            <th>จำนวน</th>
            <th>คะแนน</th>
            <th>สถานะ</th>
          </tr>
        </thead>
        <tbody id="historyTable">
          <tr>
            <td colspan="4" style="text-align:center; color:var(--muted);">
              <div class="loading" style="margin:20px auto;"></div>
              กำลังโหลดข้อมูล...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>

  <!-- Modal for Statistics -->
  <div id="statModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">สถิติ</h2>
        <button class="modal-close" onclick="closeStatModal()">&times;</button>
      </div>
      <div class="modal-stat-display">
        <div class="modal-stat-number" id="modalStatNumber">0</div>
        <div class="modal-stat-label" id="modalStatLabel">หน่วย</div>
        <div class="modal-stat-description" id="modalStatDescription">รายละเอียดสถิติ</div>
      </div>
      <div class="modal-stats-grid">
        <div class="modal-mini-stat">
          <div class="modal-mini-stat-number" id="modalMiniStat1">0</div>
          <div class="modal-mini-stat-label" id="modalMiniLabel1">เมื่อวาน</div>
        </div>
        <div class="modal-mini-stat">
          <div class="modal-mini-stat-number" id="modalMiniStat2">0</div>
          <div class="modal-mini-stat-label" id="modalMiniLabel2">เฉลี่ย</div>
        </div>
        <div class="modal-mini-stat">
          <div class="modal-mini-stat-number" id="modalMiniStat3">0</div>
          <div class="modal-mini-stat-label" id="modalMiniLabel3">สูงสุด</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Team Selection -->
  <div id="teamSelectionModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">🎨 เลือกทีมสีของคุณ</h2>
        <button class="modal-close" onclick="closeTeamSelectionModal()">&times;</button>
      </div>
      <div style="text-align: center; margin-bottom: 30px;">
        <p style="color: var(--muted); font-size: 16px; line-height: 1.6;">เลือกทีมสีที่คุณต้องการเข้าร่วม<br>ทีมสีจะช่วยให้คุณแข่งขันและร่วมมือกับเพื่อนๆ ได้</p>
      </div>
      <div class="team-selection-grid">
        <div class="team-option" data-team="red" onclick="selectTeam('red')">
          <div class="team-color-circle" style="background-color: #ef4444;"></div>
          <span class="team-name">ทีมแดง</span>
        </div>
        <div class="team-option" data-team="yellow" onclick="selectTeam('yellow')">
          <div class="team-color-circle" style="background-color: #f59e0b;"></div>
          <span class="team-name">ทีมเหลือง</span>
        </div>
        <div class="team-option" data-team="purple" onclick="selectTeam('purple')">
          <div class="team-color-circle" style="background-color: #8b5cf6;"></div>
          <span class="team-name">ทีมม่วง</span>
        </div>
        <div class="team-option" data-team="blue" onclick="selectTeam('blue')">
          <div class="team-color-circle" style="background-color: #3b82f6;"></div>
          <span class="team-name">ทีมฟ้า</span>
        </div>
        <div class="team-option" data-team="green" onclick="selectTeam('green')">
          <div class="team-color-circle" style="background-color: #10b981;"></div>
          <span class="team-name">ทีมเขียว</span>
        </div>
      </div>
      <div style="text-align: center; margin-top: 20px;">
        <button id="confirmTeamBtn" style="display: none; background: var(--brand); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: all 0.3s ease;" onclick="confirmTeamSelection()">ยืนยันการเลือกทีม</button>
      </div>
    </div>
  </div>

  <!-- Firebase to Sheets Integration -->
  <script src="./firebase-to-sheets.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, onValue, set, push, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    
    // Google Sheets integration functions are available via window.sendDataToGoogleSheets

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAmw1lDRZIxYKDblO8nhS3SR5aTVCVPJbg",
      authDomain: "takultoujink.firebaseapp.com",
      projectId: "takultoujink",
      storageBucket: "takultoujink.firebasestorage.app",
      messagingSenderId: "865462073491",
      appId: "1:865462073491:web:5985dfd8a0e91b71fa3566",
      measurementId: "G-ZVXD02VSWF",
      databaseURL: "https://takultoujink-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);
    const db = getFirestore(app);

    let currentUser = null;
    let bottleData = {
      total: 0,
      today: 0,
      weekly: 0,
      points: 0,
      history: []
    };

    // Team color mapping
    const teamColors = {
      'red': { name: 'ทีมแดง', color: '#ef4444' },
      'yellow': { name: 'ทีมเหลือง', color: '#f59e0b' },
      'purple': { name: 'ทีมม่วง', color: '#8b5cf6' },
      'blue': { name: 'ทีมฟ้า', color: '#3b82f6' },
      'green': { name: 'ทีมเขียว', color: '#10b981' }
    };

    // Load user team color from Firestore
    async function loadUserTeamColor(userId) {
      try {
        console.log('Loading team color for user:', userId);
        const userDoc = await getDoc(doc(db, 'users', userId));
        if (userDoc.exists()) {
          const userData = userDoc.data();
          const teamColor = userData.teamColor;
          console.log('User data loaded:', userData);
          console.log('Team color found:', teamColor);
          updateTeamDisplay(teamColor);
        } else {
          console.log('User document does not exist');
          updateTeamDisplay(null);
        }
      } catch (error) {
        console.error('Error loading team color:', error);
        console.error('Error code:', error.code);
        
        let errorMessage = 'เกิดข้อผิดพลาดในการโหลดข้อมูลทีมสี';
        
        if (error.code === 'permission-denied') {
          console.error('Permission denied - check Firestore security rules');
          errorMessage = 'ไม่มีสิทธิ์ในการอ่านข้อมูล กรุณาตรวจสอบการตั้งค่า Firebase Security Rules';
        } else if (error.code === 'unavailable') {
          console.error('Firestore unavailable - check internet connection');
          errorMessage = 'ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้ กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต';
        } else if (error.code === 'unauthenticated') {
          console.error('User not authenticated');
          errorMessage = 'กรุณาเข้าสู่ระบบใหม่อีกครั้ง';
        }
        
        console.error(errorMessage);
        updateTeamDisplay(null);
      }
    }

    // Update team color display
    function updateTeamDisplay(teamColor) {
      console.log('updateTeamDisplay called with teamColor:', teamColor);
      const indicator = document.getElementById('teamColorIndicator');
      const nameElement = document.getElementById('teamColorName');
      const selectTeamBtn = document.getElementById('selectTeamBtn');
      
      console.log('Elements found:', {
        indicator: !!indicator,
        nameElement: !!nameElement,
        selectTeamBtn: !!selectTeamBtn
      });
      
      if (teamColor && teamColors[teamColor]) {
        const team = teamColors[teamColor];
        console.log('Setting team display to:', team);
        if (indicator) {
          indicator.style.backgroundColor = team.color;
          indicator.style.borderColor = team.color;
        }
        if (nameElement) {
          nameElement.textContent = team.name;
        }
        if (selectTeamBtn) {
          selectTeamBtn.style.display = 'none';
        }
      } else {
        console.log('No team color or invalid team color, showing default state');
        if (indicator) {
          indicator.style.backgroundColor = 'transparent';
          indicator.style.borderColor = 'rgba(255,255,255,0.3)';
        }
        if (nameElement) {
          nameElement.textContent = 'ไม่ได้เลือกทีม';
        }
        if (selectTeamBtn) {
          selectTeamBtn.style.display = 'inline-block';
        }
      }
    }

    // Check authentication
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        document.getElementById('userName').textContent = user.displayName || user.email;
        loadUserTeamColor(user.uid);
        initDashboard();
        showWelcomeAlert();
      } else {
        window.location.href = 'login.html';
      }
    });

    // Initialize dashboard
    function initDashboard() {
      const userId = currentUser.uid;
      
      // Initialize Real-time Sync
      initRealTimeSync();
      
      // Initialize calendar
      initCalendar();
      
      // Listen for real-time updates
      const bottleRef = ref(database, `bottles/${userId}`);
      onValue(bottleRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          updateDashboard(data);
          updateConnectionStatus(true);
        } else {
          // Initialize user data if doesn't exist
          initializeUserData();
        }
      });

      // Listen for live counter updates
      const liveCountRef = ref(database, `live_count/${userId}`);
      onValue(liveCountRef, (snapshot) => {
        const count = snapshot.val();
        if (count !== null && count !== bottleData.total) {
          // New bottle detected!
          const newBottle = count - bottleData.total;
          if (newBottle > 0) {
            animateCounterUpdate(count);
            addToHistory(newBottle);
          }
        }
      });
    }

    // Initialize user data
    function initializeUserData() {
      const userId = currentUser.uid;
      const initialData = {
        total: 0,
        today: 0,
        weekly: 0,
        points: 0,
        lastUpdated: serverTimestamp(),
        history: {}
      };
      
      set(ref(database, `bottles/${userId}`), initialData);
    }

    // Update dashboard with new data
    function updateDashboard(data) {
      bottleData = data;
      
      // Update main counter
      document.getElementById('totalBottles').textContent = data.total || 0;
      
      // Update stats
      document.getElementById('todayCount').textContent = data.today || 0;
      document.getElementById('totalBottlesAll').textContent = data.total || 0;
      document.getElementById('weeklyCount').textContent = data.weekly || 0;
      
      // Calculate volunteer hours (30 bottles = 1 hour)
      const volunteerHours = Math.floor((data.total || 0) / 30);
      document.getElementById('volunteerHours').textContent = volunteerHours;
      
      // Update progress bar (goal: 100 bottles per day)
      const dailyGoal = 100;
      const progressPercent = Math.min((data.today || 0) / dailyGoal * 100, 100);
      document.getElementById('progressPercent').textContent = Math.round(progressPercent) + '%';
      document.getElementById('progressFill').style.width = progressPercent + '%';
      
      // Update last updated time
      if (data.lastUpdated) {
        const lastUpdate = new Date(data.lastUpdated);
        document.getElementById('lastUpdated').textContent = 
          `อัพเดทล่าสุด: ${lastUpdate.toLocaleString('th-TH')}`;
      }
      
      // Update history table
      updateHistoryTable(data.history);
    }

    // Animate counter update (moved to Real-time Sync section)

    // Add new bottle to history
    function addToHistory(count) {
      const userId = currentUser.uid;
      const historyRef = ref(database, `bottles/${userId}/history`);
      
      const newEntry = {
        timestamp: serverTimestamp(),
        count: count,
        points: count * 1, // 1 point per bottle
      };
      
      push(historyRef, newEntry);
    }

    // Update history table
    function updateHistoryTable(history) {
      const tbody = document.getElementById('historyTable');
      
      if (!history || Object.keys(history).length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" style="text-align:center; color:var(--muted);">
              ยังไม่มีข้อมูล
            </td>
          </tr>
        `;
        return;
      }
      
      // Convert to array and sort by timestamp (newest first)
      const historyArray = Object.entries(history)
        .map(([key, value]) => ({...value, id: key}))
        .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))
        .slice(0, 10); // Show only last 10 entries
      
      tbody.innerHTML = historyArray.map(entry => {
        const time = entry.timestamp ? 
          new Date(entry.timestamp).toLocaleString('th-TH', {
            hour: '2-digit',
            minute: '2-digit',
            day: '2-digit',
            month: '2-digit'
          }) : 'ไม่ทราบ';
        
        return `
          <tr>
            <td><span class="time-badge">${time}</span></td>
            <td>+${entry.count || 1} ขวด</td>
            <td>+${entry.points || 1} คะแนน</td>
            <td style="color:var(--ok);">✓ บันทึกแล้ว</td>
          </tr>
        `;
      }).join('');
    }

    // Update connection status
    function updateConnectionStatus(isOnline) {
      const status = document.getElementById('connectionStatus');
      const dot = status.querySelector('.pulse-dot');
      const text = status.querySelector('span');
      
      if (isOnline) {
        status.className = 'status online';
        dot.className = 'pulse-dot online';
        text.textContent = 'เชื่อมต่อแล้ว';
      } else {
        status.className = 'status offline';
        dot.className = 'pulse-dot offline';
        text.textContent = 'ออฟไลน์';
      }
    }

    // Show welcome alert
    function showWelcomeAlert() {
      const alert = document.getElementById('welcomeAlert');
      alert.style.display = 'flex';
      
      setTimeout(() => {
        alert.style.display = 'none';
      }, 8000); // Show longer to read volunteer info
    }

    // Logout function
    window.logout = async function() {
      try {
        await signOut(auth);
        window.location.href = 'login.html';
      } catch (error) {
        console.error('Logout error:', error);
      }
    };

    // Simulate real-time bottle counting (for testing)
    // Remove this in production when connecting to actual hardware
    function simulateBottleCount() {
      if (!currentUser) return;
      
      setInterval(() => {
        const userId = currentUser.uid;
        const newBottles = Math.floor(Math.random() * 3); // Add 0-2 bottles randomly
        const currentCount = bottleData.total + newBottles;
        
        if (newBottles > 0) {
          // Update live count
          set(ref(database, `live_count/${userId}`), currentCount);
          
          // Update main bottle data
          const updates = {
            total: currentCount,
            today: (bottleData.today || 0) + newBottles,
            weekly: (bottleData.weekly || 0) + newBottles,
            points: (bottleData.points || 0) + newBottles,
            lastUpdated: serverTimestamp()
          };
          
          set(ref(database, `bottles/${userId}`), {
            ...bottleData,
            ...updates
          });
          
          // Show sync notification
          showSyncNotification(`เพิ่มขวด ${newBottles} ใบ - ซิงค์สำเร็จ`, 'success');
          
          // ส่งข้อมูลไปยัง Google Sheets
          sendBottleDataToSheets({
            uid: userId,
            displayName: currentUser.displayName || currentUser.email,
            email: currentUser.email,
            bottlesAdded: newBottles,
            totalBottles: currentCount,
            todayBottles: (bottleData.today || 0) + newBottles,
            weeklyBottles: (bottleData.weekly || 0) + newBottles,
            points: (bottleData.points || 0) + newBottles
          });
        }
      }, 12000); // Update every 12 seconds for demo
    }

    // ฟังก์ชันส่งข้อมูลขวดไปยัง Google Sheets
    async function sendBottleDataToSheets(bottleData) {
      try {
        console.log('Sending bottle data to Google Sheets...', bottleData);
        
        // เตรียมข้อมูลสำหรับส่งไป Google Sheets
        const sheetData = {
          timestamp: new Date().toISOString(),
          action: 'bottle_collection',
          uid: bottleData.uid || '',
          displayName: bottleData.displayName || '',
          email: bottleData.email || '',
          bottlesAdded: bottleData.bottlesAdded || 0,
          totalBottles: bottleData.totalBottles || 0,
          todayBottles: bottleData.todayBottles || 0,
          weeklyBottles: bottleData.weeklyBottles || 0,
          points: bottleData.points || 0,
          location: 'Dashboard',
          deviceType: 'Web'
        };
        
        const result = await sendDataToGoogleSheets(
          sheetData, 
          '1qemalIVHWjZ_7uTrlyTZ6I1B9MqoD6gyyv9_E5fiOmQ', // Google Sheet ID
          'BottleCollection' // Sheet name
        );
        
        if (result.success) {
          console.log('Bottle data sent to Google Sheets successfully');
          showSyncNotification('ข้อมูลส่งไป Google Sheets สำเร็จ', 'success');
        } else {
          console.warn('Failed to send bottle data to Google Sheets:', result.error);
          showSyncNotification('ไม่สามารถส่งข้อมูลไป Google Sheets ได้', 'error');
        }
      } catch (error) {
        console.error('Error sending bottle data to Google Sheets:', error);
        showSyncNotification('เกิดข้อผิดพลาดในการส่งข้อมูล', 'error');
        // ไม่ให้ error นี้หยุดการทำงานของระบบ
      }
    }

    // Start simulation for demo (remove in production)
    setTimeout(simulateBottleCount, 5000);

    // Real-time Sync Functions
    let syncStatus = 'disconnected';
    let lastSyncTime = null;
    let syncIndicator = null;
    let deviceConnections = new Map();
    let syncQueue = [];
    let isOnline = navigator.onLine;

    // Initialize Real-time Sync
    function initRealTimeSync() {
      console.log('🔄 Initializing Real-time Sync...');
      
      // Create sync status indicator
      createSyncIndicator();
      
      // Setup Firebase real-time listeners
      setupRealtimeListeners();
      
      // Setup online/offline detection
      setupNetworkDetection();
      
      // Setup device presence tracking
      setupDevicePresence();
      
      // Setup periodic sync check
      setupPeriodicSync();
      
      // Process any queued sync operations
      processOfflineQueue();
    }

    // Create sync status indicator in the navbar
    function createSyncIndicator() {
      const navbar = document.querySelector('.navbar');
      if (!navbar) return;
      
      syncIndicator = document.createElement('div');
      syncIndicator.className = 'sync-indicator';
      syncIndicator.innerHTML = `
        <div class="sync-status" id="syncStatus">
          <span class="sync-icon">🔄</span>
          <span class="sync-text">กำลังเชื่อมต่อ...</span>
          <span class="sync-time" id="syncTime"></span>
        </div>
        <div class="device-count" id="deviceCount" title="อุปกรณ์ที่เชื่อมต่อ">
          <span class="device-icon">📱</span>
          <span class="device-number">0</span>
        </div>
      `;
      
      // Add CSS for sync indicator
      const style = document.createElement('style');
      style.textContent = `
        .sync-indicator {
          display: flex;
          align-items: center;
          gap: 15px;
          margin-left: auto;
          margin-right: 15px;
          font-size: 12px;
          color: var(--text-color);
        }
        
        .sync-status {
          display: flex;
          align-items: center;
          gap: 5px;
          padding: 4px 8px;
          border-radius: 12px;
          background: rgba(255,255,255,0.1);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255,255,255,0.2);
          transition: all 0.3s ease;
        }
        
        .sync-status.connected {
          background: rgba(76, 175, 80, 0.2);
          border-color: rgba(76, 175, 80, 0.4);
          color: #4CAF50;
        }
        
        .sync-status.syncing {
          background: rgba(255, 193, 7, 0.2);
          border-color: rgba(255, 193, 7, 0.4);
          color: #FFC107;
        }
        
        .sync-status.disconnected {
          background: rgba(244, 67, 54, 0.2);
          border-color: rgba(244, 67, 54, 0.4);
          color: #F44336;
        }
        
        .sync-icon {
          animation: none;
        }
        
        .sync-status.syncing .sync-icon {
          animation: spin 1s linear infinite;
        }
        
        .device-count {
          display: flex;
          align-items: center;
          gap: 3px;
          padding: 4px 6px;
          border-radius: 8px;
          background: rgba(255,255,255,0.1);
          cursor: pointer;
          transition: all 0.3s ease;
        }
        
        .device-count:hover {
          background: rgba(255,255,255,0.2);
          transform: scale(1.05);
        }
        
        .sync-notification {
          position: fixed;
          top: 80px;
          right: 20px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 12px 16px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 1000;
          transform: translateX(100%);
          transition: transform 0.3s ease;
          font-size: 14px;
          max-width: 300px;
        }
        
        .sync-notification.show {
          transform: translateX(0);
        }
        
        .sync-notification.success {
          background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }
        
        .sync-notification.error {
          background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }
        
        .device-modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
          z-index: 2000;
          justify-content: center;
          align-items: center;
        }
        
        .device-modal-content {
          background: var(--card-bg);
          border-radius: 16px;
          padding: 24px;
          max-width: 500px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
          box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .device-list {
          margin-top: 16px;
        }
        
        .device-item {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 12px;
          border-radius: 8px;
          background: rgba(255,255,255,0.05);
          margin-bottom: 8px;
          border: 1px solid rgba(255,255,255,0.1);
        }
        
        .device-icon-type {
          font-size: 20px;
        }
        
        .device-info {
          flex: 1;
        }
        
        .device-name {
          font-weight: 600;
          margin-bottom: 4px;
        }
        
        .device-details {
          font-size: 12px;
          opacity: 0.7;
        }
        
        .device-status {
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 11px;
          font-weight: 600;
        }
        
        .device-status.online {
          background: rgba(76, 175, 80, 0.2);
          color: #4CAF50;
        }
        
        .device-status.offline {
          background: rgba(244, 67, 54, 0.2);
          color: #F44336;
        }
        
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        
        .sync-time {
          font-size: 10px;
          opacity: 0.7;
        }
      `;
      document.head.appendChild(style);
      
      // Insert before user info
      const userInfo = navbar.querySelector('.user-info');
      if (userInfo) {
        navbar.insertBefore(syncIndicator, userInfo);
      } else {
        navbar.appendChild(syncIndicator);
      }
    }

    // Setup Firebase real-time listeners
    function setupRealtimeListeners() {
      if (!currentUser) return;
      
      console.log('🔗 Setting up real-time listeners...');
      
      // Listen to bottle count changes
      const bottleRef = ref(database, `bottles/${currentUser.uid}`);
      onValue(bottleRef, (snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          console.log('📊 Real-time bottle data received:', data);
          
          // Update UI with real-time data
          updateBottleDisplay(data);
          updateSyncStatus('connected', 'ซิงค์แล้ว');
          
          // Broadcast to other tabs/windows
          broadcastDataUpdate('bottles', data);
        }
      }, (error) => {
        console.error('❌ Error in bottle listener:', error);
        updateSyncStatus('disconnected', 'ขาดการเชื่อมต่อ');
      });
      
      // Listen to live count changes
      const liveCountRef = ref(database, `live_count/${currentUser.uid}`);
      onValue(liveCountRef, (snapshot) => {
        if (snapshot.exists()) {
          const count = snapshot.val();
          console.log('🔴 Live count update:', count);
          
          // Update main counter with animation
          animateCounterUpdate(count);
          updateSyncStatus('syncing', 'กำลังซิงค์...');
          
          setTimeout(() => {
            updateSyncStatus('connected', 'ซิงค์แล้ว');
          }, 1000);
        }
      });
      
      // Listen to user presence
      const presenceRef = ref(database, `presence/${currentUser.uid}`);
      onValue(presenceRef, (snapshot) => {
        if (snapshot.exists()) {
          const presenceData = snapshot.val();
          console.log('👤 User presence update:', presenceData);
        }
      });
      
      // Listen to global device connections
      const devicesRef = ref(database, 'devices');
      onValue(devicesRef, (snapshot) => {
        if (snapshot.exists()) {
          const devices = snapshot.val();
          updateDeviceCount(devices);
        }
      });
    }
    
    // Setup network detection
    function setupNetworkDetection() {
      console.log('🌐 Setting up network detection...');
      
      // Initial status
      updateNetworkStatus(navigator.onLine);
      
      // Listen for online/offline events
      window.addEventListener('online', () => {
        console.log('✅ Network: Online');
        isOnline = true;
        updateNetworkStatus(true);
        processOfflineQueue();
        
        // Reconnect Firebase listeners
        if (currentUser) {
          setupRealtimeListeners();
        }
      });
      
      window.addEventListener('offline', () => {
        console.log('❌ Network: Offline');
        isOnline = false;
        updateNetworkStatus(false);
        updateSyncStatus('disconnected', 'ออฟไลน์');
      });
    }
    
    // Setup device presence tracking
    function setupDevicePresence() {
      if (!currentUser) return;
      
      console.log('📱 Setting up device presence...');
      
      const deviceId = generateDeviceId();
      const deviceRef = ref(database, `devices/${deviceId}`);
      const userDeviceRef = ref(database, `presence/${currentUser.uid}/${deviceId}`);
      
      // Device info
      const deviceInfo = {
        userId: currentUser.uid,
        userEmail: currentUser.email,
        deviceType: getDeviceType(),
        browser: getBrowserInfo(),
        lastSeen: serverTimestamp(),
        isOnline: true,
        timestamp: new Date().toISOString()
      };
      
      // Set device presence
      set(deviceRef, deviceInfo);
      set(userDeviceRef, deviceInfo);
      
      // Setup disconnect handler
      const disconnectRef = ref(database, `devices/${deviceId}`);
      onDisconnect(disconnectRef).set({
        ...deviceInfo,
        isOnline: false,
        lastSeen: serverTimestamp()
      });
      
      // Update presence every 30 seconds
      setInterval(() => {
        if (isOnline && currentUser) {
          set(deviceRef, {
            ...deviceInfo,
            lastSeen: serverTimestamp(),
            timestamp: new Date().toISOString()
          });
        }
      }, 30000);
    }
    
    // Setup periodic sync check
    function setupPeriodicSync() {
      console.log('⏰ Setting up periodic sync...');
      
      // Check sync status every 10 seconds
      setInterval(() => {
        if (isOnline && currentUser) {
          checkSyncHealth();
        }
      }, 10000);
      
      // Update sync time display
      setInterval(() => {
        updateSyncTimeDisplay();
      }, 1000);
    }

    // Utility functions for Real-time Sync
    function updateSyncStatus(status, message) {
      syncStatus = status;
      lastSyncTime = new Date();
      
      const syncStatusEl = document.getElementById('syncStatus');
      const syncTextEl = syncStatusEl?.querySelector('.sync-text');
      
      if (syncStatusEl && syncTextEl) {
        // Remove all status classes
        syncStatusEl.classList.remove('connected', 'syncing', 'disconnected');
        // Add current status class
        syncStatusEl.classList.add(status);
        // Update text
        syncTextEl.textContent = message;
        
        console.log(`🔄 Sync Status: ${status} - ${message}`);
      }
    }
    
    function updateNetworkStatus(online) {
      if (online) {
        updateSyncStatus('connected', 'เชื่อมต่อแล้ว');
        showSyncNotification('เชื่อมต่ออินเทอร์เน็ตแล้ว', 'success');
      } else {
        updateSyncStatus('disconnected', 'ออฟไลน์');
        showSyncNotification('การเชื่อมต่ออินเทอร์เน็ตขาดหาย', 'error');
      }
    }
    
    // updateDeviceCount function moved to enhanced version below
    
    function updateSyncTimeDisplay() {
      const syncTimeEl = document.getElementById('syncTime');
      if (syncTimeEl && lastSyncTime) {
        const now = new Date();
        const diff = Math.floor((now - lastSyncTime) / 1000);
        
        let timeText = '';
        if (diff < 60) {
          timeText = `${diff}วิ`;
        } else if (diff < 3600) {
          timeText = `${Math.floor(diff / 60)}นาที`;
        } else {
          timeText = `${Math.floor(diff / 3600)}ชม`;
        }
        
        syncTimeEl.textContent = timeText;
      }
    }
    
    function animateCounterUpdate(newCount) {
      const counterEl = document.getElementById('totalBottles');
      if (!counterEl) return;
      
      // Add update animation
      counterEl.style.transform = 'scale(1.1)';
      counterEl.style.color = '#4CAF50';
      
      // Animate number change
      const currentCount = parseInt(counterEl.textContent) || 0;
      animateNumber(counterEl, currentCount, newCount, 1000);
      
      setTimeout(() => {
        counterEl.style.transform = 'scale(1)';
        counterEl.style.color = '';
      }, 500);
    }
    
    function animateNumber(element, start, end, duration) {
      const startTime = performance.now();
      const difference = end - start;
      
      function updateNumber(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        const current = Math.floor(start + (difference * progress));
        element.textContent = current.toLocaleString();
        
        if (progress < 1) {
          requestAnimationFrame(updateNumber);
        }
      }
      
      requestAnimationFrame(updateNumber);
    }
    
    function updateBottleDisplay(data) {
      // Update main counter
      const totalBottlesEl = document.getElementById('totalBottles');
      if (totalBottlesEl && data.total !== undefined) {
        totalBottlesEl.textContent = data.total.toLocaleString();
      }
      
      // Update today count
      const todayCountEl = document.getElementById('todayCount');
      if (todayCountEl && data.today !== undefined) {
        todayCountEl.textContent = data.today;
      }
      
      // Update weekly count
      const weeklyCountEl = document.getElementById('weeklyCount');
      if (weeklyCountEl && data.weekly !== undefined) {
        weeklyCountEl.textContent = data.weekly;
      }
      
      // Update volunteer hours
      const volunteerHoursEl = document.getElementById('volunteerHours');
      if (volunteerHoursEl && data.total !== undefined) {
        const hours = (data.total / 30).toFixed(1);
        volunteerHoursEl.textContent = hours;
      }
      
      // Update progress bar
      updateProgressBar(data.today || 0);
      
      // Update last updated time
      const lastUpdatedEl = document.getElementById('lastUpdated');
      if (lastUpdatedEl) {
        lastUpdatedEl.textContent = `อัปเดตล่าสุด: ${new Date().toLocaleTimeString('th-TH')}`;
      }
    }
    
    function updateProgressBar(todayCount) {
      const dailyGoal = 50; // Default daily goal
      const progress = Math.min((todayCount / dailyGoal) * 100, 100);
      
      const progressFillEl = document.getElementById('progressFill');
      const progressPercentEl = document.getElementById('progressPercent');
      
      if (progressFillEl) {
        progressFillEl.style.width = `${progress}%`;
      }
      
      if (progressPercentEl) {
        progressPercentEl.textContent = `${Math.round(progress)}%`;
      }
    }
    
    function generateDeviceId() {
      // Generate a unique device ID based on browser fingerprint
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.textBaseline = 'top';
      ctx.font = '14px Arial';
      ctx.fillText('Device fingerprint', 2, 2);
      
      const fingerprint = canvas.toDataURL();
      const deviceId = btoa(fingerprint).slice(0, 16) + '_' + Date.now();
      
      return deviceId;
    }
    
    function getDeviceType() {
      const userAgent = navigator.userAgent;
      if (/tablet|ipad|playbook|silk/i.test(userAgent)) {
        return 'tablet';
      } else if (/mobile|iphone|ipod|android|blackberry|opera|mini|windows\sce|palm|smartphone|iemobile/i.test(userAgent)) {
        return 'mobile';
      } else {
        return 'desktop';
      }
    }
    
    function getBrowserInfo() {
      const userAgent = navigator.userAgent;
      let browser = 'Unknown';
      
      if (userAgent.includes('Chrome')) browser = 'Chrome';
      else if (userAgent.includes('Firefox')) browser = 'Firefox';
      else if (userAgent.includes('Safari')) browser = 'Safari';
      else if (userAgent.includes('Edge')) browser = 'Edge';
      
      return browser;
    }
    
    function broadcastDataUpdate(type, data) {
      // Broadcast to other tabs/windows using BroadcastChannel
      if ('BroadcastChannel' in window) {
        const channel = new BroadcastChannel('bottle-sync');
        channel.postMessage({
          type: 'data-update',
          dataType: type,
          data: data,
          timestamp: Date.now(),
          userId: currentUser?.uid
        });
      }
    }
    
    function processOfflineQueue() {
      if (!isOnline || syncQueue.length === 0) return;
      
      console.log(`📤 Processing ${syncQueue.length} queued operations...`);
      
      const queue = [...syncQueue];
      syncQueue = [];
      
      queue.forEach(async (operation) => {
        try {
          await operation.execute();
          console.log('✅ Queued operation completed:', operation.type);
        } catch (error) {
          console.error('❌ Failed to execute queued operation:', error);
          // Re-queue if failed
          syncQueue.push(operation);
        }
      });
    }
    
    function checkSyncHealth() {
      if (!currentUser || !isOnline) return;
      
      // Check if we haven't received updates for too long
      const now = new Date();
      if (lastSyncTime && (now - lastSyncTime) > 60000) { // 1 minute
        console.log('⚠️ Sync health check: No updates for 1 minute, reconnecting...');
        setupRealtimeListeners();
      }
    }
    
    // Listen for messages from other tabs
    if ('BroadcastChannel' in window) {
      const syncChannel = new BroadcastChannel('bottle-sync');
      syncChannel.addEventListener('message', (event) => {
        const { type, dataType, data, userId } = event.data;
        
        if (type === 'data-update' && userId !== currentUser?.uid) {
          console.log('📨 Received data update from another tab:', dataType, data);
          
          if (dataType === 'bottles') {
            updateBottleDisplay(data);
            showSyncNotification('ข้อมูลได้รับการซิงค์จากอุปกรณ์อื่น', 'success');
          }
        }
      });
    }
    
    // Show sync notification
    function showSyncNotification(message, type = 'info') {
      // Remove existing notification
      const existingNotification = document.querySelector('.sync-notification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      // Create new notification
      const notification = document.createElement('div');
      notification.className = `sync-notification ${type}`;
      notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px;">
          <span>${type === 'success' ? '✅' : type === 'error' ? '❌' : '🔄'}</span>
          <span>${message}</span>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // Show notification
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);
      
      // Hide notification after 3 seconds
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }
    
    // Show device modal
    function showDeviceModal() {
      // Create modal if it doesn't exist
      let modal = document.getElementById('deviceModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'deviceModal';
        modal.className = 'device-modal';
        modal.innerHTML = `
          <div class="device-modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 style="margin: 0;">🔗 อุปกรณ์ที่เชื่อมต่อ</h3>
              <button onclick="closeDeviceModal()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-color);">×</button>
            </div>
            <div id="deviceList" class="device-list">
              <!-- Device list will be populated here -->
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }
      
      // Populate device list
      updateDeviceList();
      
      // Show modal
      modal.style.display = 'flex';
    }
    
    function closeDeviceModal() {
      const modal = document.getElementById('deviceModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    function updateDeviceList() {
      const deviceList = document.getElementById('deviceList');
      if (!deviceList) return;
      
      if (deviceConnections.size === 0) {
        deviceList.innerHTML = `
          <div style="text-align: center; padding: 20px; opacity: 0.7;">
            <p>ไม่มีอุปกรณ์อื่นเชื่อมต่ออยู่</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      deviceConnections.forEach((device, userId) => {
        const deviceTypeIcon = device.deviceType === 'mobile' ? '📱' : 
                              device.deviceType === 'tablet' ? '📱' : '💻';
        const lastSeenTime = device.lastSeen ? new Date(device.lastSeen).toLocaleString('th-TH') : 'ไม่ทราบ';
        
        html += `
          <div class="device-item">
            <div class="device-icon-type">${deviceTypeIcon}</div>
            <div class="device-info">
              <div class="device-name">${device.browser || 'Unknown Browser'} - ${device.deviceType || 'Unknown'}</div>
              <div class="device-details">
                ${device.userEmail || 'Unknown User'}<br>
                เข้าใช้ล่าสุด: ${lastSeenTime}
              </div>
            </div>
            <div class="device-status ${device.isOnline ? 'online' : 'offline'}">
              ${device.isOnline ? 'ออนไลน์' : 'ออฟไลน์'}
            </div>
          </div>
        `;
      });
      
      deviceList.innerHTML = html;
    }
    
    // Add click event to device count
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        const deviceCount = document.getElementById('deviceCount');
        if (deviceCount) {
          deviceCount.addEventListener('click', showDeviceModal);
        }
      }, 1000);
    });
    
    // Enhanced updateDeviceCount function
    function updateDeviceCount(devices) {
      if (!devices) return;
      
      const onlineDevices = Object.values(devices).filter(device => device.isOnline);
      const deviceCountEl = document.querySelector('.device-number');
      
      if (deviceCountEl) {
        const previousCount = parseInt(deviceCountEl.textContent) || 0;
        const newCount = onlineDevices.length;
        
        deviceCountEl.textContent = newCount;
        
        // Show notification if device count changed
        if (previousCount !== newCount && previousCount > 0) {
          if (newCount > previousCount) {
            showSyncNotification(`อุปกรณ์ใหม่เชื่อมต่อแล้ว (${newCount} อุปกรณ์)`, 'success');
          } else {
            showSyncNotification(`อุปกรณ์ตัดการเชื่อมต่อ (${newCount} อุปกรณ์)`, 'info');
          }
        }
        
        // Store device connections for reference
        deviceConnections.clear();
        onlineDevices.forEach(device => {
          deviceConnections.set(device.userId || 'unknown', device);
        });
        
        console.log(`📱 Online devices: ${onlineDevices.length}`);
      }
    }

    // Calendar functionality
    let currentCalendarDate = new Date();
    let selectedDate = null;
    let calendarData = {};

    // Initialize calendar
    function initCalendar() {
      generateCalendar();
      setupCalendarEvents();
    }

    // Generate calendar for current month
    function generateCalendar() {
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      
      // Update month header
      const monthNames = [
        'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
        'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
      ];
      document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year + 543}`;
      
      // Get first day of month and number of days
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();
      
      // Generate calendar grid
      const calendarGrid = document.getElementById('calendarGrid');
      calendarGrid.innerHTML = '';
      
      // Add weekday headers
      const weekdays = ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'];
      weekdays.forEach(day => {
        const weekdayElement = document.createElement('div');
        weekdayElement.className = 'calendar-weekday';
        weekdayElement.textContent = day;
        calendarGrid.appendChild(weekdayElement);
      });
      
      // Add empty cells for days before month starts
      for (let i = 0; i < startingDayOfWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day other-month';
        calendarGrid.appendChild(emptyDay);
      }
      
      // Add days of the month
      const today = new Date();
      for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        
        const currentDate = new Date(year, month, day);
        const dateKey = formatDateKey(currentDate);
        
        // Check if it's today
        if (currentDate.toDateString() === today.toDateString()) {
          dayElement.classList.add('today');
        }
        
        // Check if there's data for this day
        const dayData = getDayData(dateKey);
        if (dayData && dayData.bottles > 0) {
          dayElement.classList.add('has-data');
        }
        
        // Create day content
        const dayNumber = document.createElement('div');
        dayNumber.className = 'calendar-day-number';
        dayNumber.textContent = day;
        dayElement.appendChild(dayNumber);
        
        if (dayData && dayData.bottles > 0) {
          const bottleCount = document.createElement('div');
          bottleCount.className = 'calendar-day-bottles';
          bottleCount.textContent = `${dayData.bottles} ขวด`;
          dayElement.appendChild(bottleCount);
        }
        
        // Add click event
        dayElement.addEventListener('click', () => selectDate(currentDate, dayElement));
        
        calendarGrid.appendChild(dayElement);
      }
    }

    // Setup calendar navigation events
    function setupCalendarEvents() {
      document.getElementById('prevMonth').addEventListener('click', () => {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
        generateCalendar();
      });
      
      document.getElementById('nextMonth').addEventListener('click', () => {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
        generateCalendar();
      });
    }

    // Select a date and show details
    function selectDate(date, element) {
      // Remove previous selection
      document.querySelectorAll('.calendar-day.selected').forEach(el => {
        el.classList.remove('selected');
      });
      
      // Add selection to clicked element
      element.classList.add('selected');
      selectedDate = date;
      
      // Show date info
      showDateInfo(date);
    }

    // Show information for selected date
    function showDateInfo(date) {
      const dateKey = formatDateKey(date);
      const dayData = getDayData(dateKey);
      
      // Update selected date display
      const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        locale: 'th-TH'
      };
      document.getElementById('selectedDate').textContent = 
        `วันที่ ${date.getDate()} ${getThaiMonth(date.getMonth())} ${date.getFullYear() + 543}`;
      
      // Update stats
      const bottles = dayData ? dayData.bottles : 0;
      const points = dayData ? dayData.points : 0;
      const hours = Math.floor(bottles / 30);
      
      document.getElementById('selectedDateBottles').textContent = bottles;
      document.getElementById('selectedDatePoints').textContent = points;
      document.getElementById('selectedDateHours').textContent = hours;
      
      // Show activities
      showDateActivities(dayData);
      
      // Show the info panel
      document.getElementById('selectedDateInfo').style.display = 'block';
    }

    // Show activities for selected date
    function showDateActivities(dayData) {
      const activitiesContainer = document.getElementById('dateActivities');
      
      if (!dayData || !dayData.activities || dayData.activities.length === 0) {
        activitiesContainer.innerHTML = '<p style="text-align:center; color:var(--muted); margin:16px 0;">ไม่มีกิจกรรมในวันนี้</p>';
        return;
      }
      
      activitiesContainer.innerHTML = dayData.activities.map(activity => `
        <div class="activity-item">
          <div>
            <div class="activity-time">${activity.time}</div>
            <div>เก็บขวดได้</div>
          </div>
          <div class="activity-bottles">+${activity.bottles} ขวด</div>
        </div>
      `).join('');
    }

    // Get data for a specific day
    function getDayData(dateKey) {
      return calendarData[dateKey] || null;
    }

    // Format date as key (YYYY-MM-DD)
    function formatDateKey(date) {
      return date.toISOString().split('T')[0];
    }

    // Get Thai month name
    function getThaiMonth(monthIndex) {
      const months = [
        'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
        'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
      ];
      return months[monthIndex];
    }

    // Process history data for calendar
    function processHistoryForCalendar(history) {
      calendarData = {};
      
      if (!history) return;
      
      Object.values(history).forEach(entry => {
        if (entry.timestamp) {
          const date = new Date(entry.timestamp);
          const dateKey = formatDateKey(date);
          
          if (!calendarData[dateKey]) {
            calendarData[dateKey] = {
              bottles: 0,
              points: 0,
              activities: []
            };
          }
          
          calendarData[dateKey].bottles += entry.count || 1;
          calendarData[dateKey].points += entry.points || 1;
          calendarData[dateKey].activities.push({
            time: date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }),
            bottles: entry.count || 1
          });
        }
      });
      
      // Regenerate calendar with new data
      generateCalendar();
    }

    // Generate sample data for demonstration
    function generateSampleCalendarData() {
      const today = new Date();
      const sampleData = {};
      
      // Generate data for the last 30 days
      for (let i = 0; i < 30; i++) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateKey = formatDateKey(date);
        
        // Random bottle count (0-15)
        const bottles = Math.floor(Math.random() * 16);
        if (bottles > 0) {
          sampleData[dateKey] = {
            bottles: bottles,
            points: bottles,
            activities: [
              {
                time: '09:30',
                bottles: Math.ceil(bottles / 2)
              },
              {
                time: '14:15',
                bottles: Math.floor(bottles / 2)
              }
            ].filter(activity => activity.bottles > 0)
          };
        }
      }
      
      calendarData = sampleData;
      generateCalendar();
    }

    // Initialize calendar when dashboard loads
    setTimeout(() => {
      initCalendar();
      generateSampleCalendarData(); // Remove this in production
    }, 1000);

    // Update calendar when history data changes
    const originalUpdateHistoryTable = updateHistoryTable;
    updateHistoryTable = function(history) {
      originalUpdateHistoryTable(history);
      processHistoryForCalendar(history);
    };
  </script>
  
  <!-- Music Player JavaScript -->
  <script>
    // Music Player Variables
     let isPlaying = false;
     let currentVolume = 50;
     let musicPlayer = null;
     let backgroundMusic = null;
     let audioContext = null;
     let oscillator = null;
     let gainNode = null;
     let usingWebAudio = false;
    
    // Initialize Music Player
    function initMusicPlayer() {
      backgroundMusic = document.getElementById('backgroundMusic');
      musicPlayer = document.getElementById('musicPlayer');
      
      if (backgroundMusic) {
        backgroundMusic.volume = currentVolume / 100;
        
        // Event listeners for audio
        backgroundMusic.addEventListener('loadstart', function() {
          console.log('เริ่มโหลดเพลง...');
        });
        
        backgroundMusic.addEventListener('canplay', function() {
          console.log('เพลงพร้อมเล่น');
        });
        
        backgroundMusic.addEventListener('error', function(e) {
           console.log('ไม่สามารถโหลดเพลงได้:', e);
           console.log('กำลังสลับไปใช้ Web Audio API...');
           initWebAudio();
           updateMusicInfo('🎼 เสียงสังเคราะห์', 'ผ่อนคลาย');
         });
        
        backgroundMusic.addEventListener('ended', function() {
          // Auto replay when song ends
          if (isPlaying) {
            backgroundMusic.currentTime = 0;
            backgroundMusic.play();
          }
        });
      }
    }
     
     // Initialize Web Audio API for fallback
     function initWebAudio() {
       try {
         audioContext = new (window.AudioContext || window.webkitAudioContext)();
         gainNode = audioContext.createGain();
         gainNode.connect(audioContext.destination);
         gainNode.gain.value = currentVolume / 100;
         usingWebAudio = true;
         console.log('Web Audio API พร้อมใช้งาน');
       } catch (error) {
         console.log('ไม่สามารถใช้ Web Audio API ได้:', error);
         usingWebAudio = false;
       }
     }
     
     // Create ambient tone using Web Audio API
     function createAmbientTone() {
       if (!audioContext || !gainNode) return;
       
       // Stop existing oscillator
       if (oscillator) {
         oscillator.stop();
         oscillator = null;
       }
       
       // Create new oscillator for ambient sound
       oscillator = audioContext.createOscillator();
       const filter = audioContext.createBiquadFilter();
       
       // Configure ambient tone (low frequency, soft)
       oscillator.type = 'sine';
       oscillator.frequency.setValueAtTime(220, audioContext.currentTime); // A3 note
       
       // Add some variation
       oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 4);
       oscillator.frequency.exponentialRampToValueAtTime(240, audioContext.currentTime + 8);
       
       // Low-pass filter for softer sound
       filter.type = 'lowpass';
       filter.frequency.setValueAtTime(800, audioContext.currentTime);
       filter.Q.setValueAtTime(1, audioContext.currentTime);
       
       // Connect nodes
       oscillator.connect(filter);
       filter.connect(gainNode);
       
       // Start the tone
       oscillator.start();
       
       // Auto-restart when ended (for looping)
       oscillator.onended = function() {
         if (isPlaying && usingWebAudio) {
           setTimeout(() => createAmbientTone(), 100);
         }
       };
     }
     
     // Stop Web Audio
     function stopWebAudio() {
       if (oscillator) {
         oscillator.stop();
         oscillator = null;
       }
     }
     
     // Toggle Music Play/Pause
    function toggleMusic() {
      if (!backgroundMusic) {
        console.log('ไม่พบไฟล์เพลง');
        return;
      }
      
      if (isPlaying) {
        pauseMusic();
      } else {
        playMusic();
      }
    }
    
    // Play Music
     function playMusic() {
       if (usingWebAudio) {
         // Use Web Audio API
         if (audioContext && audioContext.state === 'suspended') {
           audioContext.resume();
         }
         createAmbientTone();
         isPlaying = true;
         updatePlayButton();
         musicPlayer.classList.add('playing');
         updateMusicInfo('🎼 เสียงสังเคราะห์', 'ผ่อนคลาย');
         console.log('เริ่มเล่นเสียงสังเคราะห์');
         return;
       }
       
       if (!backgroundMusic) {
         // Try to initialize Web Audio as fallback
         initWebAudio();
         if (usingWebAudio) {
           playMusic();
         }
         return;
       }
       
       backgroundMusic.play().then(() => {
         isPlaying = true;
         updatePlayButton();
         musicPlayer.classList.add('playing');
         updateMusicInfo('🎵 เพลงแจ๊สเงียบๆ', 'ผ่อนคลาย');
         console.log('เริ่มเล่นเพลง');
       }).catch((error) => {
         console.log('ไม่สามารถเล่นเพลงได้:', error);
         
         // Try Web Audio API as fallback
         initWebAudio();
         if (usingWebAudio) {
           playMusic();
         } else {
           updateMusicInfo('⚠️ ไม่สามารถเล่นเพลง', 'คลิกเพื่อลองใหม่');
           
           // Show user-friendly message
           if (error.name === 'NotAllowedError') {
             alert('เบราว์เซอร์ไม่อนุญาตให้เล่นเพลงอัตโนมัติ\nกรุณาคลิกปุ่มเล่นเพลงอีกครั้ง');
           }
         }
       });
     }
    
    // Pause Music
     function pauseMusic() {
       if (usingWebAudio) {
         stopWebAudio();
         isPlaying = false;
         updatePlayButton();
         musicPlayer.classList.remove('playing');
         updateMusicInfo('⏸️ หยุดเสียงสังเคราะห์', 'คลิกเพื่อเล่น');
         console.log('หยุดเล่นเสียงสังเคราะห์');
         return;
       }
       
       if (!backgroundMusic) return;
       
       backgroundMusic.pause();
       isPlaying = false;
       updatePlayButton();
       musicPlayer.classList.remove('playing');
       updateMusicInfo('⏸️ หยุดเล่นเพลง', 'คลิกเพื่อเล่น');
       console.log('หยุดเล่นเพลง');
     }
    
    // Update Play/Pause Button
    function updatePlayButton() {
      const playIcon = document.getElementById('playIcon');
      if (playIcon) {
        playIcon.textContent = isPlaying ? '⏸️' : '▶️';
      }
    }
    
    // Change Volume
     function changeVolume(value) {
       currentVolume = parseInt(value);
       
       // Update volume for both audio sources
       if (backgroundMusic) {
         backgroundMusic.volume = currentVolume / 100;
       }
       
       if (gainNode) {
         gainNode.gain.value = currentVolume / 100;
       }
       
       // Update volume icon based on level
       const volumeIcon = document.querySelector('.volume-icon');
       if (volumeIcon) {
         if (currentVolume === 0) {
           volumeIcon.textContent = '🔇';
         } else if (currentVolume < 30) {
           volumeIcon.textContent = '🔈';
         } else if (currentVolume < 70) {
           volumeIcon.textContent = '🔉';
         } else {
           volumeIcon.textContent = '🔊';
         }
       }
       
       console.log('ปรับระดับเสียง:', currentVolume + '%');
     }
    
    // Update Music Info Display
    function updateMusicInfo(title, artist) {
      const musicTitle = document.getElementById('musicTitle');
      const musicArtist = document.getElementById('musicArtist');
      
      if (musicTitle) musicTitle.textContent = title;
      if (musicArtist) musicArtist.textContent = artist;
    }
    
    // Auto-play music when page loads (if browser allows)
    function tryAutoPlay() {
      // Wait a bit for user interaction, then try to play
      setTimeout(() => {
        if (!isPlaying) {
          playMusic();
        }
      }, 2000);
    }
    
    // Initialize music player when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      initMusicPlayer();
    });
    
    // Try auto-play after user interaction
    document.addEventListener('click', function() {
      if (!isPlaying && backgroundMusic && !backgroundMusic.src.includes('undefined')) {
        // Only try once per session
        if (!sessionStorage.getItem('musicAutoPlayAttempted')) {
          sessionStorage.setItem('musicAutoPlayAttempted', 'true');
          setTimeout(() => {
            if (!isPlaying) {
              playMusic();
            }
          }, 1000);
        }
      }
    }, { once: true });
  </script>
  
  <!-- AOS Animation Library Script -->
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <script>
    // Initialize AOS
    AOS.init({
      duration: 1000,
      easing: 'ease-in-out',
      once: true,
      mirror: false
    });

    // Modal functions
    window.openStatModal = function(type) {
      const modal = document.getElementById('statModal');
      const title = document.getElementById('modalTitle');
      const number = document.getElementById('modalStatNumber');
      const label = document.getElementById('modalStatLabel');
      const description = document.getElementById('modalStatDescription');
      const miniStat1 = document.getElementById('modalMiniStat1');
      const miniLabel1 = document.getElementById('modalMiniLabel1');
      const miniStat2 = document.getElementById('modalMiniStat2');
      const miniLabel2 = document.getElementById('modalMiniLabel2');
      const miniStat3 = document.getElementById('modalMiniStat3');
      const miniLabel3 = document.getElementById('modalMiniLabel3');

      // Get current data from global variables
       const currentData = window.dashboardData || {};
       const todayBottles = parseInt(document.getElementById('todayCount').textContent) || 0;
       const totalBottles = parseInt(document.getElementById('totalBottlesAll').textContent) || 0;
       const weeklyBottles = parseInt(document.getElementById('weeklyCount').textContent) || 0;
       const volunteerHours = parseFloat(document.getElementById('volunteerHours').textContent) || 0;

       switch(type) {
         case 'today':
           title.textContent = '🌟 ขวดวันนี้';
           number.textContent = todayBottles;
           label.textContent = 'ขวด';
           description.textContent = 'จำนวนขวดที่เก็บได้ในวันนี้ ช่วยลดขยะพลาสติกในสิ่งแวดล้อม';
           // Calculate related stats
           const yesterdayBottles = Math.max(0, todayBottles - Math.floor(Math.random() * 5) + 2);
           const avgDaily = Math.round(totalBottles / Math.max(1, (Date.now() - new Date('2024-01-01').getTime()) / (1000 * 60 * 60 * 24)));
           const maxDaily = Math.max(todayBottles, avgDaily + Math.floor(Math.random() * 10) + 5);
           miniStat1.textContent = yesterdayBottles;
           miniLabel1.textContent = 'เมื่อวาน';
           miniStat2.textContent = avgDaily;
           miniLabel2.textContent = 'เฉลี่ย/วัน';
           miniStat3.textContent = maxDaily;
           miniLabel3.textContent = 'สูงสุด/วัน';
           break;
         case 'volunteer':
           title.textContent = '⏰ ชั่วโมงจิตอาสา';
           number.textContent = volunteerHours.toFixed(1);
           label.textContent = 'ชั่วโมง';
           description.textContent = 'เวลาที่ใช้ในการช่วยเหลือสิ่งแวดล้อมและชุมชน';
           // Calculate volunteer hours based on bottles (assume 0.1 hour per bottle)
           const yesterdayHours = Math.max(0, volunteerHours - 0.5 + Math.random());
           const avgHours = (totalBottles * 0.1) / Math.max(1, (Date.now() - new Date('2024-01-01').getTime()) / (1000 * 60 * 60 * 24));
           const maxHours = Math.max(volunteerHours, avgHours + 2);
           miniStat1.textContent = yesterdayHours.toFixed(1);
           miniLabel1.textContent = 'เมื่อวาน';
           miniStat2.textContent = avgHours.toFixed(1);
           miniLabel2.textContent = 'เฉลี่ย/วัน';
           miniStat3.textContent = maxHours.toFixed(1);
           miniLabel3.textContent = 'สูงสุด/วัน';
           break;
         case 'total':
           title.textContent = '🏆 ขวดรวมทั้งหมด';
           number.textContent = totalBottles;
           label.textContent = 'ขวด';
           description.textContent = 'จำนวนขวดทั้งหมดที่เก็บได้ตั้งแต่เริ่มต้น ผลงานสะสมของคุณ';
           // Calculate monthly and goals based on total
           const monthlyBottles = Math.round(totalBottles * 0.3); // Assume 30% this month
           const dailyAvg = Math.round(totalBottles / Math.max(1, (Date.now() - new Date('2024-01-01').getTime()) / (1000 * 60 * 60 * 24)));
           const goalBottles = Math.max(totalBottles + 100, Math.round(totalBottles * 1.2));
           miniStat1.textContent = monthlyBottles;
           miniLabel1.textContent = 'เดือนนี้';
           miniStat2.textContent = dailyAvg;
           miniLabel2.textContent = 'เฉลี่ย/วัน';
           miniStat3.textContent = goalBottles;
           miniLabel3.textContent = 'เป้าหมาย';
           break;
         case 'weekly':
           title.textContent = '📅 ขวดสัปดาห์นี้';
           number.textContent = weeklyBottles;
           label.textContent = 'ขวด';
           description.textContent = 'จำนวนขวดที่เก็บได้ในสัปดาห์นี้ ความก้าวหน้าประจำสัปดาห์';
           // Calculate weekly stats
           const lastWeekBottles = Math.max(0, weeklyBottles - Math.floor(Math.random() * 20) + 10);
           const avgWeekly = Math.round(totalBottles / Math.max(1, (Date.now() - new Date('2024-01-01').getTime()) / (1000 * 60 * 60 * 24 * 7)));
           const maxWeekly = Math.max(weeklyBottles, avgWeekly + Math.floor(Math.random() * 30) + 15);
           miniStat1.textContent = lastWeekBottles;
           miniLabel1.textContent = 'สัปดาห์ที่แล้ว';
           miniStat2.textContent = avgWeekly;
           miniLabel2.textContent = 'เฉลี่ย/สัปดาห์';
           miniStat3.textContent = maxWeekly;
           miniLabel3.textContent = 'สูงสุด/สัปดาห์';
           break;
       }

      modal.style.display = 'flex';
       setTimeout(() => {
         modal.classList.add('active');
       }, 10);
     };

     window.closeStatModal = function() {
       const modal = document.getElementById('statModal');
       modal.classList.remove('active');
       setTimeout(() => {
         modal.style.display = 'none';
       }, 300);
     };

    // Close modal when clicking outside
    document.getElementById('statModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeStatModal();
      }
    });

    // Team selection modal functions
    let selectedTeamColor = null;

    window.openTeamSelectionModal = function() {
      const modal = document.getElementById('teamSelectionModal');
      modal.style.display = 'flex';
      setTimeout(() => {
        modal.classList.add('active');
      }, 10);
    };

    window.closeTeamSelectionModal = function() {
      const modal = document.getElementById('teamSelectionModal');
      modal.classList.remove('active');
      setTimeout(() => {
        modal.style.display = 'none';
        // Reset selection
        document.querySelectorAll('.team-option').forEach(option => {
          option.classList.remove('selected');
        });
        document.getElementById('confirmTeamBtn').style.display = 'none';
        selectedTeamColor = null;
      }, 300);
    };

    window.selectTeam = function(teamColor) {
      // Remove previous selection
      document.querySelectorAll('.team-option').forEach(option => {
        option.classList.remove('selected');
      });
      
      // Add selection to clicked team
      const selectedOption = document.querySelector(`[data-team="${teamColor}"]`);
      selectedOption.classList.add('selected');
      
      // Store selected team
      selectedTeamColor = teamColor;
      
      // Show confirm button
      document.getElementById('confirmTeamBtn').style.display = 'inline-block';
    };

    window.confirmTeamSelection = async function() {
      console.log('confirmTeamSelection called!');
      console.log('selectedTeamColor:', selectedTeamColor);
      console.log('currentUser:', currentUser);
      
      if (!selectedTeamColor) {
        alert('กรุณาเลือกทีมก่อนยืนยัน');
        return;
      }
      
      if (!currentUser) {
        alert('กรุณาเข้าสู่ระบบก่อนเลือกทีม');
        return;
      }
      
      try {
        console.log('Saving team color to Firestore...');
        console.log('User ID:', currentUser.uid);
        console.log('Selected team color:', selectedTeamColor);
        
        // Check if user document exists first
        const userDocRef = doc(db, 'users', currentUser.uid);
        const userDoc = await getDoc(userDocRef);
        
        if (!userDoc.exists()) {
          console.log('User document does not exist, creating new one...');
          await setDoc(userDocRef, {
            uid: currentUser.uid,
            displayName: currentUser.displayName || '',
            email: currentUser.email,
            teamColor: selectedTeamColor,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          });
        } else {
          console.log('User document exists, updating team color...');
          await updateDoc(userDocRef, {
            teamColor: selectedTeamColor,
            updatedAt: new Date().toISOString()
          });
        }
        
        console.log('Team color saved successfully!');
        
        // Update display immediately
        updateTeamDisplay(selectedTeamColor);
        
        // Reload user team color to ensure consistency
        setTimeout(() => {
          console.log('Reloading team color after save...');
          loadUserTeamColor(currentUser.uid);
        }, 500);
        
        // Close modal
        closeTeamSelectionModal();
        
        // Show success message
        const teamName = teamColors[selectedTeamColor].name;
        alert(`เลือก${teamName}เรียบร้อยแล้ว! 🎉`);
        
      } catch (error) {
        console.error('Error saving team color:', error);
        console.error('Error details:', error.code, error.message);
        
        let errorMessage = 'เกิดข้อผิดพลาดในการบันทึกข้อมูล';
        
        if (error.code === 'permission-denied') {
          errorMessage = 'ไม่มีสิทธิ์ในการบันทึกข้อมูล กรุณาตรวจสอบการตั้งค่า Firebase Security Rules';
        } else if (error.code === 'unavailable') {
          errorMessage = 'ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้ กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต';
        } else if (error.code === 'unauthenticated') {
          errorMessage = 'กรุณาเข้าสู่ระบบใหม่อีกครั้ง';
        } else {
          errorMessage += ': ' + error.message;
        }
        
        alert(errorMessage);
        // Reload team color in case of error to show current state
        loadUserTeamColor(currentUser.uid);
      }
    };

    // Close team selection modal when clicking outside
    document.getElementById('teamSelectionModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeTeamSelectionModal();
      }
    });
  </script>

  <script>
    // Mobile Navigation Toggle Function
    let mobileNavOpen = false;
    
    window.toggleMobileNav = function() {
      const navActions = document.getElementById('navActions');
      const hamburgerIcon = document.getElementById('hamburgerIcon');
      
      if (mobileNavOpen) {
        // Close mobile nav
        navActions.classList.remove('mobile-visible');
        navActions.classList.add('mobile-hidden');
        hamburgerIcon.textContent = '☰';
        mobileNavOpen = false;
        
        // Remove backdrop
        const backdrop = document.getElementById('mobileNavBackdrop');
        if (backdrop) {
          backdrop.remove();
        }
      } else {
        // Open mobile nav
        navActions.classList.remove('mobile-hidden');
        navActions.classList.add('mobile-visible');
        hamburgerIcon.textContent = '✕';
        mobileNavOpen = true;
        
        // Add backdrop
        const backdrop = document.createElement('div');
        backdrop.id = 'mobileNavBackdrop';
        backdrop.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 999;
          backdrop-filter: blur(5px);
        `;
        backdrop.onclick = toggleMobileNav;
        document.body.appendChild(backdrop);
      }
    };
    
    // Close mobile nav when window is resized to desktop size
    window.addEventListener('resize', function() {
      if (window.innerWidth > 768 && mobileNavOpen) {
        toggleMobileNav();
      }
    });
    
    // Close mobile nav when clicking on nav links
    document.addEventListener('click', function(e) {
      if (mobileNavOpen && e.target.closest('.nav-actions a, .nav-actions button')) {
        setTimeout(toggleMobileNav, 100);
      }
    });
  </script>

  <!-- Back to Top Button -->
  <button id="backToTopBtn" class="back-to-top-btn" onclick="scrollToTop()" title="กลับไปด้านบน">
    <i class="fas fa-chevron-up"></i>
  </button>

  <style>
    .back-to-top-btn {
      position: fixed;
      bottom: 30px;
      left: 30px;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      box-shadow: var(--shadow-soft);
      transition: all 0.3s ease;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transform: translateY(20px);
    }

    .back-to-top-btn.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .back-to-top-btn:hover {
      background: linear-gradient(135deg, var(--brand-2), var(--accent));
      transform: translateY(-3px);
      box-shadow: var(--shadow);
    }

    .back-to-top-btn:active {
      transform: translateY(-1px);
    }

    @media (max-width: 768px) {
       .back-to-top-btn {
         bottom: 20px;
         left: 20px;
        width: 45px;
        height: 45px;
        font-size: 16px;
      }
    }
  </style>

  <script>
    // Back to Top functionality
    function scrollToTop() {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }

    // Show/hide back to top button based on scroll position
    window.addEventListener('scroll', function() {
      const backToTopBtn = document.getElementById('backToTopBtn');
      if (window.pageYOffset > 0) {
        backToTopBtn.classList.add('show');
      } else {
        backToTopBtn.classList.remove('show');
      }
    });

    // Image Modal Functions
    function openImageModal(imageSrc, imageAlt) {
      const modal = document.getElementById('imageModal');
      const modalImg = document.getElementById('modalImage');
      const caption = document.getElementById('modalCaption');
      
      modal.style.display = 'block';
      modalImg.src = imageSrc;
      caption.textContent = imageAlt;
      document.body.style.overflow = 'hidden';
    }

    function closeImageModal() {
      const modal = document.getElementById('imageModal');
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // Close modal when clicking outside the image
    window.onclick = function(event) {
      const modal = document.getElementById('imageModal');
      if (event.target === modal) {
        closeImageModal();
      }
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeImageModal();
      }
    });
  </script>

  <!-- Image Modal -->
  <div id="imageModal" class="image-modal">
    <span class="modal-close" onclick="closeImageModal()">&times;</span>
    <img class="modal-content" id="modalImage">
    <div id="modalCaption" class="modal-caption"></div>
  </div>

  <style>
    .image-modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(5px);
    }

    .modal-content {
      margin: auto;
      display: block;
      max-width: 90%;
      max-height: 90%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border-radius: 12px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      animation: modalZoom 0.3s ease-out;
    }

    @keyframes modalZoom {
      from {
        transform: translate(-50%, -50%) scale(0.7);
        opacity: 0;
      }
      to {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 35px;
      color: #fff;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
      z-index: 10000;
      transition: color 0.3s ease;
    }

    .modal-close:hover {
      color: #ff6b6b;
    }

    .modal-caption {
      margin: auto;
      display: block;
      width: 80%;
      max-width: 700px;
      text-align: center;
      color: #ccc;
      padding: 20px 0;
      font-size: 18px;
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      border-radius: 8px;
      padding: 10px 20px;
    }

    @media (max-width: 768px) {
      .modal-content {
        max-width: 95%;
        max-height: 85%;
      }
      
      .modal-close {
        top: 10px;
        right: 20px;
        font-size: 30px;
      }
      
      .modal-caption {
        font-size: 16px;
        width: 90%;
        bottom: 10px;
      }
    }
  </style>

  <script>
    // Search System JavaScript
    let searchData = [];
    
    function initializeSearch() {
      // Collect all headings and important elements for search
      const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6, .card-title, .stat-label, .activity-title, .section-title');
      
      searchData = [];
      headings.forEach((element, index) => {
        const text = element.textContent.trim();
        if (text && text.length > 1) {
          // Determine section based on element location
          let section = 'ทั่วไป';
          const parent = element.closest('.card, .stat-item, .activity-item, .section');
          
          if (element.closest('.stats-grid')) {
            section = 'สถิติ';
          } else if (element.closest('.activities')) {
            section = 'กิจกรรม';
          } else if (element.closest('.header')) {
            section = 'หัวข้อหลัก';
          } else if (element.closest('.card')) {
            section = 'การ์ด';
          }
          
          // Determine appropriate icon
          let icon = '📄';
          if (section === 'หัวข้อหลัก') icon = '🏠';
          else if (section === 'สถิติ') icon = '📊';
          else if (section === 'กิจกรรม') icon = '🎯';
          else if (section === 'การ์ด') icon = '📋';
          
          searchData.push({
            id: `search-item-${index}`,
            title: text,
            section: section,
            element: element,
            icon: icon
          });
        }
      });
    }
    
    function openSearch() {
      const overlay = document.getElementById('searchOverlay');
      const input = document.getElementById('searchInput');
      
      overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
      
      // Focus on input after animation
      setTimeout(() => {
        input.focus();
      }, 300);
      
      // Initialize search data if not already done
      if (searchData.length === 0) {
        initializeSearch();
      }
    }
    
    function closeSearch() {
      const overlay = document.getElementById('searchOverlay');
      const input = document.getElementById('searchInput');
      const results = document.getElementById('searchResults');
      
      overlay.classList.remove('active');
      document.body.style.overflow = '';
      
      // Clear search
      input.value = '';
      results.innerHTML = `
        <div class="search-placeholder">
          <div class="search-placeholder-icon">📝</div>
          <p>พิมพ์คำค้นหาเพื่อดูผลลัพธ์</p>
        </div>
      `;
      
      // Remove any existing highlights
      document.querySelectorAll('.search-highlight').forEach(el => {
        el.outerHTML = el.innerHTML;
      });
    }
    
    function performSearch() {
      const query = document.getElementById('searchInput').value.toLowerCase().trim();
      const results = document.getElementById('searchResults');
      
      if (!query) {
        results.innerHTML = `
          <div class="search-placeholder">
            <div class="search-placeholder-icon">📝</div>
            <p>พิมพ์คำค้นหาเพื่อดูผลลัพธ์</p>
          </div>
        `;
        return;
      }
      
      // Filter search data
      const filteredResults = searchData.filter(item => 
        item.title.toLowerCase().includes(query) ||
        item.section.toLowerCase().includes(query)
      );
      
      if (filteredResults.length === 0) {
        results.innerHTML = `
          <div class="search-placeholder">
            <div class="search-placeholder-icon">❌</div>
            <p>ไม่พบผลลัพธ์สำหรับ "${query}"</p>
          </div>
        `;
        return;
      }
      
      // Display results
      results.innerHTML = filteredResults.map(item => `
        <div class="search-result-item" onclick="scrollToElement('${item.id}')">
          <div class="search-result-icon">${item.icon}</div>
          <div class="search-result-content">
            <div class="search-result-title">${highlightText(item.title, query)}</div>
            <div class="search-result-section">${item.section}</div>
          </div>
        </div>
      `).join('');
    }
    
    function highlightText(text, query) {
      if (!query) return text;
      const regex = new RegExp(`(${query})`, 'gi');
      return text.replace(regex, '<mark style="background: var(--brand); color: white; padding: 2px 4px; border-radius: 3px;">$1</mark>');
    }
    
    function scrollToElement(itemId) {
      const item = searchData.find(item => item.id === itemId);
      if (item && item.element) {
        closeSearch();
        
        // Smooth scroll to element
        item.element.scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });
        
        // Highlight the element temporarily
        item.element.style.transition = 'all 0.3s ease';
        item.element.style.background = 'rgba(59, 130, 246, 0.3)';
        item.element.style.borderRadius = '8px';
        item.element.style.padding = '8px';
        
        setTimeout(() => {
          item.element.style.background = '';
          item.element.style.borderRadius = '';
          item.element.style.padding = '';
        }, 2000);
      }
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Ctrl/Cmd + K to open search
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        openSearch();
      }
      
      // Escape to close search
      if (e.key === 'Escape') {
        const overlay = document.getElementById('searchOverlay');
        if (overlay.classList.contains('active')) {
          closeSearch();
        }
      }
    });
    
    // Click outside to close
    document.getElementById('searchOverlay').addEventListener('click', function(e) {
      if (e.target === this) {
        closeSearch();
      }
    });
    
    // Initialize search when page loads
    document.addEventListener('DOMContentLoaded', function() {
      initializeSearch();
    });
  </script>

</body>
</html>